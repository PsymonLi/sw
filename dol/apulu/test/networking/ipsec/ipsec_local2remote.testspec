# Test Spec for local2remote scenarios from Host
selectors:
    root: ref://store/templates/id=FLOW
    maxlimits: 1
    # if route table has a default route,
    # then the packet might end up going to internet gateway instead of getting dropped.
    flow: filter://HasDefaultRoute=False
    vnic: filter://any

packets:
    - packet:
        id          : FROM_HOST_PKT # Input packet
        payloadsize : ref://factory/payloads/id=PAYLOAD_ZERO64/size
        template    : callback://networking/packets/GetPacketTemplateFromMapping/proto=TCP
        encaps      : callback://networking/packets/GetHostPacketEncapFromVnic
        headers     :
            eth:
                src     : ref://testcase/config/localmapping/VNIC/MACAddr
                dst     : callback://networking/packets/GetDstMac/direction=TX
            qtag:
                vlan    : callback://networking/packets/GetVnicQTag
            ipv4:
                src     : ref://testcase/config/localmapping/IP
                dst     : ref://testcase/config/remotemapping/IP
                ttl     : 64 
            ipv6:
                src     : ref://testcase/config/localmapping/IP
                dst     : ref://testcase/config/remotemapping/IP
                hlim    : 64
            tcp:
                sport   : 100
                dport   : 200
                flags   : syn
            payload:
                data    : ref://factory/payloads/id=PAYLOAD_ZERO64/data

    - packet:
        id          : TO_SWITCH_PKT # Expected packet
        payloadsize : 226
        template    : ref://factory/packets/id=ETH_IPV4_ESP
        headers     :
            eth:
                src     : callback://networking/packets/GetUplinkPortMac
                dst     : callback://networking/packets/GetUnderlayRemoteMac
            ipv4:
                src     : ref://testcase/config/devicecfg/IP
                dst     : callback://networking/packets/GetTunnelIPFromMapping
                ttl     : 255
                tos     : ref://testcase/config/localmapping/VNIC/SUBNET/ToS
                id      : 0
                len     : 212
            esp:   
                spi     : 7
                seq     : 0
            payload:
                data    :   0xaa 0xaa 0xaa 0xaa 0xaa 0xaa
                            0xaa 0xaa 0xce 0x34 0x5f 0x68 0x12 0x70
                            0x30 0x3c 0x53 0x6f 0xa2 0x02 0x33 0x4c
                            0x9f 0x0e 0xdb 0x7f 0x3a 0x77 0xad 0x72
                            0x51 0xe8 0x85 0xb2 0x7f 0x4d 0x5a 0x8a
                            0x82 0x0d 0x54 0x27 0xe3 0xa4 0x97 0x2b
                            0xf8 0x49 0x13 0x6c 0xf4 0xa0 0x88 0x2d
                            0x5c 0x7e 0xc2 0xe6 0xf7 0x6a 0x47 0x61
                            0xfe 0xf1 0xfb 0xdf 0x58 0x95 0xa5 0xc0
                            0xee 0x99 0x0c 0x55 0x0a 0x6d 0x28 0xc5
                            0x54 0x4c 0xca 0x06 0x49 0xc6 0xe5 0xf0
                            0xae 0x57 0xa1 0xd0 0xb6 0x27 0x8e 0x06
                            0x9c 0x4e 0x55 0x7a 0xd9 0xc9 0x41 0xef
                            0xe5 0x38 0xfb 0x13 0xf4 0xf4 0x17 0xcb
                            0xb6 0x22 0xbc 0x77 0xc1 0x79 0x98 0x2a
                            0xd7 0x00 0x43 0xcb 0x17 0x49 0x4f 0x9e
                            0x0e 0x20 0x09 0xb1 0x99 0x11 0x01 0x17
                            0x5c 0xe7 0x8f 0x1e 0xdb 0x7e 0x76 0xe0
                            0x88 0x03 0xde 0x3b 0x48 0x50 0x02 0xab
                            0x10 0xaf 0x45 0xdb 0x11 0x04 0x49 0x3c
                            0x46 0x5c 0xdf 0x3d 0xce 0x42 0x41 0x2d
                            0xfa 0x49 0x30 0x98 0x8d 0xbe 0x8d 0xbc
                            0x8b 0xe5 0xf1 0x59 0xfa 0x4f 0xf3 0x56
                            0x76 0x9e

buffers:
    - buffer:
        id      : BUF1
        template: ref://factory/templates/id=ETH_BUFFER
        fields:
           bind : True
           size : ref://testcase/packets/id=FROM_HOST_PKT/size
           data : ref://testcase/packets/id=FROM_HOST_PKT/rawbytes

descriptors:
    - descriptor:
        id      : DESC1
        template: ref://factory/templates/id=DESCR_ETH_TX
        fields:
            _buf  : ref://testcase/buffers/id=BUF1
            addr  : ref://testcase/buffers/id=BUF1/addr
            len   : ref://testcase/buffers/id=BUF1/size

    - descriptor:
        id      : DESC2 # Expected Descriptor
        template: ref://factory/templates/id=DESCR_ETH_TX_CQ
        fields:
            status     : 0x0

session:
    - step:
        trigger:
            descriptors:
                - descriptor:
                    object  : ref://testcase/descriptors/id=DESC1
                    ring    : callback://networking/packets/GetRingFromMapping/type=local,qid=TX
        expect:
            delay    :    1
            packets:
                - packet:
                    object  : callback://networking/packets/GetExpectedPacket/ipkt=FROM_HOST_PKT,epkt_pass=TO_SWITCH_PKT,direction=TX
                    port    : callback://networking/packets/GetExpectedEgressUplinkPort
            descriptors:
                - descriptor:
                    object  : ref://testcase/descriptors/id=DESC2
                    ring    : callback://networking/packets/GetRingFromMapping/type=local,qid=TX
