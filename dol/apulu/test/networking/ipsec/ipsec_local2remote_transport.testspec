# Test Spec for local2remote scenarios from Host
selectors:
    root: ref://store/templates/id=FLOW
    maxlimits: 1
    # if route table has a default route,
    # then the packet might end up going to internet gateway instead of getting dropped.
    flow: filter://HasDefaultRoute=False
    vnic: filter://any

packets:
    - packet:
        id          : FROM_HOST_PKT # Input packet
        payloadsize : ref://factory/payloads/id=PAYLOAD_ZERO64/size
        template    : callback://networking/packets/GetPacketTemplateFromMapping/proto=TCP
        encaps      : callback://networking/packets/GetHostPacketEncapFromVnic
        headers     :
            eth:
                src     : ref://testcase/config/localmapping/VNIC/MACAddr
                dst     : callback://networking/packets/GetDstMac/direction=TX
            qtag:
                vlan    : callback://networking/packets/GetVnicQTag
            ipv4:
                src     : ref://testcase/config/localmapping/IP
                dst     : ref://testcase/config/remotemapping/IP
                ttl     : 64 
            ipv6:
                src     : ref://testcase/config/localmapping/IP
                dst     : ref://testcase/config/remotemapping/IP
                hlim    : 64
            tcp:
                sport   : 100
                dport   : 200
                flags   : syn
            payload:
                data    : ref://factory/payloads/id=PAYLOAD_ZERO64/data

    - packet:
        id          : TO_SWITCH_PKT # Expected packet
        payloadsize : 226
        template    : ref://factory/packets/id=ETH_IPV4_ESP
        headers     :
            eth:
                src     : callback://networking/packets/GetUplinkPortMac
                dst     : callback://networking/packets/GetUnderlayRemoteMac
            ipv4:
                src     : ref://testcase/config/devicecfg/IP
                #dst     : callback://networking/packets/GetTunnelIPFromMapping
                dst     : 172.16.0.12
                ttl     : 64
                tos     : ref://testcase/config/localmapping/VNIC/SUBNET/ToS
                id      : 0
                len     : 196
            esp:   
                spi     : 2
                seq     : 0
            payload:
                data    :    0xaa 0xaa 0xaa 0xaa 0xaa 0xaa
                             0xaa 0xaa 0x61 0x9e 0x4d 0x47 0x12 0xf6
                             0x30 0x3c 0x1b 0x7e 0x80 0x2b 0x9e 0x64
                             0x1b 0x0f 0x77 0x81 0x3a 0x7e 0x6d 0x81
                             0x43 0x80 0x85 0x34 0x7f 0x4f 0x5a 0x8a
                             0xc7 0x0a 0x55 0x77 0x67 0xa5 0x97 0xc5
                             0xb8 0x4f 0x71 0x12 0xf8 0x7d 0x88 0x2f
                             0x50 0x7c 0xca 0xec 0xb2 0x09 0x47 0xc1
                             0xfe 0xf0 0xe9 0xeb 0x18 0x93 0x91 0x39
                             0xb2 0x9b 0x2c 0x57 0x0b 0xd2 0x28 0xc3
                             0x54 0x28 0xca 0xce 0x49 0xc6 0xf7 0xc4
                             0xae 0x57 0xf7 0xa8 0xe6 0x25 0xae 0x06
                             0x91 0x8d 0x55 0x7a 0xd9 0xc9 0x41 0xef
                             0xe5 0x38 0xfb 0x13 0xf4 0xf4 0x17 0xcb
                             0xb6 0x22 0xbc 0x77 0xc1 0x79 0x98 0x2a
                             0xd7 0x00 0x43 0xcb 0x17 0x49 0x4f 0x9e
                             0x0e 0x20 0x09 0xb1 0x99 0x11 0x01 0x17
                             0x5c 0xe7 0x8f 0x1e 0xdb 0x7e 0x76 0xe0
                             0x89 0x01 0xdd 0x3f 0x4d 0x56 0x05 0xa3
                             0x18 0xbe 0x3e 0x67 0x24 0xe6 0xe2 0x18
                             0xae 0x57 0x6a 0x59 0x25 0x47 0xf9 0xdf
                             0xd9 0xa8


buffers:
    - buffer:
        id      : BUF1
        template: ref://factory/templates/id=ETH_BUFFER
        fields:
           bind : True
           size : ref://testcase/packets/id=FROM_HOST_PKT/size
           data : ref://testcase/packets/id=FROM_HOST_PKT/rawbytes

descriptors:
    - descriptor:
        id      : DESC1
        template: ref://factory/templates/id=DESCR_ETH_TX
        fields:
            _buf  : ref://testcase/buffers/id=BUF1
            addr  : ref://testcase/buffers/id=BUF1/addr
            len   : ref://testcase/buffers/id=BUF1/size

    - descriptor:
        id      : DESC2 # Expected Descriptor
        template: ref://factory/templates/id=DESCR_ETH_TX_CQ
        fields:
            status     : 0x0

session:
    - step:
        trigger:
            descriptors:
                - descriptor:
                    object  : ref://testcase/descriptors/id=DESC1
                    ring    : callback://networking/packets/GetRingFromMapping/type=local,qid=TX
        expect:
            delay    :    1
            packets:
                - packet:
                    object  : callback://networking/packets/GetExpectedPacket/ipkt=FROM_HOST_PKT,epkt_pass=TO_SWITCH_PKT,direction=TX
                    port    : callback://networking/packets/GetExpectedEgressUplinkPort
            descriptors:
                - descriptor:
                    object  : ref://testcase/descriptors/id=DESC2
                    ring    : callback://networking/packets/GetRingFromMapping/type=local,qid=TX
