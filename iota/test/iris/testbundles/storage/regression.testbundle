meta:
    name        : storage
    os          : [ linux, freebsd ]
    nics        : [ pensando, intel, mellanox, broadcom ]
    targetcount : 6000

# Bugs and TODOs:
# - PS-347: Enable 512 batch_depth after it is fixed.

aliases:
    - &STORAGE_TEST_DIR storage/offload/src/test
    - &BLOCK_SIZE_2K 2048
    - &BLOCK_SIZE_4K 4096
    - &BLOCK_SIZE_8K 8192
    - &BLOCK_SIZE_16K 16384
    - &BLOCK_SIZE_32K 32768
    - &CPUS_ITER_LIST [ 1, 2, 4, 6, 8, 16, 24 ]
    - &BATCH_DEPTH_ITER_LIST [ 1, 16, 31, 32, 33, 64 ]
    - &BATCH_DEPTH_LARGE_ITER_LIST [ 128, 256 ]
    - &BATCH_DEPTH_ITER_LIST_ZERO_PAD [ 1, 16, 31, 32, 33, 64 ]
    - &BATCH_DEPTH_LARGE_ITER_LIST_ZERO_PAD [ 128, 256, 512 ]
    - &MODE_ITER_LIST [ sync, poll, async ]
    - &CPDC_TEST_YML cpdc.yml
    - &CP_FAIL_TEST_YML cp_fail.yml
    - &DC_FAIL_TEST_YML dc_fail.yml
    - &HASH_TEST_YML hash.yml
    - &CHKSUM_TEST_YML chksum.yml
    - &CPFLAGS_DEFAULT 0
    - &DCFLAGS_DEFAULT 0
    - &CPFLAGS_ZERO_PAD zero_pad
    - &DCFLAGS_ZERO_PAD 0
    - &CPFLAGS_WITH_HEADER insert_header
    - &DCFLAGS_WITH_HEADER header_present
    - &CPFLAGS_WITH_HEADER_ZERO_PAD insert_header,zero_pad
    - &DCFLAGS_WITH_HEADER_ZERO_PAD header_present
    - &HASH_FLAGS_LIST [ '0', 'per_block' ]
    - &HASH_ALGO_LIST [ 'sha2_256' ]
    - &CHKSUM_FLAGS_LIST [ '0', 'per_block' ]
    - &CHKSUM_ALGO_LIST [ 'crc32c' ]

testcases:
    -   name    : CompileInsmodSonicPencake
        testcase: testcases.storage.compile_install_drivers
        args    :
            package: storage/gen/storage-offload.tar.xz
            maxcpus: 32

    -   name: CpDcDefault4K8K
        testcase    : testcases.storage.ymltest2
        iterators   :
            type        : nested
            cpus        : *CPUS_ITER_LIST
            batch_depth : *BATCH_DEPTH_ITER_LIST
            mode        : *MODE_ITER_LIST
            blocksize   : [ *BLOCK_SIZE_4K, *BLOCK_SIZE_8K ]
        args    :
            test        : *CPDC_TEST_YML
            cpflags     : *CPFLAGS_DEFAULT
            dcflags     : *DCFLAGS_DEFAULT

    #PS-347
    -   name: CpDcDefault4K8KLargeBD
        testcase    : testcases.storage.ymltest2
        ignore      : True
        iterators   :
            type        : nested
            cpus        : *CPUS_ITER_LIST
            batch_depth : *BATCH_DEPTH_LARGE_ITER_LIST
            mode        : *MODE_ITER_LIST
            blocksize   : [ *BLOCK_SIZE_4K, *BLOCK_SIZE_8K ]
        args    :
            test        : *CPDC_TEST_YML
            cpflags     : *CPFLAGS_DEFAULT
            dcflags     : *DCFLAGS_DEFAULT

    # PS-345
    -   name: CpDcZeroPad4K8K
        testcase    : testcases.storage.ymltest2
        ignore      : True
        iterators   :
            type        : nested
            cpus        : *CPUS_ITER_LIST
            batch_depth : *BATCH_DEPTH_ITER_LIST_ZERO_PAD
            mode        : *MODE_ITER_LIST
            blocksize   : [ *BLOCK_SIZE_4K, *BLOCK_SIZE_8K ]
        args    :
            blocksize   : *BLOCK_SIZE_4K
            test        : *CPDC_TEST_YML
            cpflags     : *CPFLAGS_ZERO_PAD
            dcflags     : *DCFLAGS_ZERO_PAD

    # PS-339
    -   name: CpDcZeroPad4K8KLargeBD
        testcase    : testcases.storage.ymltest2
        enable      : False
        ignore      : True
        iterators   :
            type        : nested
            cpus        : *CPUS_ITER_LIST
            batch_depth : *BATCH_DEPTH_LARGE_ITER_LIST_ZERO_PAD
            mode        : *MODE_ITER_LIST
            blocksize   : [ *BLOCK_SIZE_4K, *BLOCK_SIZE_8K ]
        args    :
            blocksize   : *BLOCK_SIZE_4K
            test        : *CPDC_TEST_YML
            cpflags     : *CPFLAGS_ZERO_PAD
            dcflags     : *DCFLAGS_ZERO_PAD

    -   name: CpDcWithHeader4K8K
        testcase    : testcases.storage.ymltest2
        iterators   :
            type        : nested
            cpus        : *CPUS_ITER_LIST
            batch_depth : *BATCH_DEPTH_ITER_LIST
            mode        : *MODE_ITER_LIST
            blocksize   : [ *BLOCK_SIZE_4K, *BLOCK_SIZE_8K ]
        args    :
            blocksize   : *BLOCK_SIZE_4K
            test        : *CPDC_TEST_YML
            cpflags     : *CPFLAGS_WITH_HEADER
            dcflags     : *DCFLAGS_WITH_HEADER

    # PS-341
    -   name: CpDcWithHeader4K8KLargeBD
        testcase    : testcases.storage.ymltest2
        ignore      : True
        iterators   :
            type        : nested
            cpus        : *CPUS_ITER_LIST
            batch_depth : *BATCH_DEPTH_LARGE_ITER_LIST
            mode        : *MODE_ITER_LIST
            blocksize   : [ *BLOCK_SIZE_4K, *BLOCK_SIZE_8K ]
        args    :
            blocksize   : *BLOCK_SIZE_4K
            test        : *CPDC_TEST_YML
            cpflags     : *CPFLAGS_WITH_HEADER
            dcflags     : *DCFLAGS_WITH_HEADER

    # PS-340
    -   name: CpDcWithHeaderZeroPad4K8K
        testcase    : testcases.storage.ymltest2
        ignore      : True
        iterators   :
            type        : nested
            cpus        : *CPUS_ITER_LIST
            batch_depth : *BATCH_DEPTH_ITER_LIST_ZERO_PAD
            mode        : *MODE_ITER_LIST
            blocksize   : [ *BLOCK_SIZE_4K, *BLOCK_SIZE_8K ]
        args    :
            blocksize   : *BLOCK_SIZE_4K
            test        : *CPDC_TEST_YML
            cpflags     : *CPFLAGS_WITH_HEADER_ZERO_PAD
            dcflags     : *DCFLAGS_WITH_HEADER_ZERO_PAD

    # PS-344
    -   name: CpDcWithHeaderZeroPad4K8KLargeBD
        testcase    : testcases.storage.ymltest2
        enable      : False
        ignore      : True
        iterators   :
            type        : nested
            cpus        : *CPUS_ITER_LIST
            batch_depth : *BATCH_DEPTH_LARGE_ITER_LIST_ZERO_PAD
            mode        : *MODE_ITER_LIST
            blocksize   : [ *BLOCK_SIZE_4K, *BLOCK_SIZE_8K ]
        args    :
            blocksize   : *BLOCK_SIZE_4K
            test        : *CPDC_TEST_YML
            cpflags     : *CPFLAGS_WITH_HEADER_ZERO_PAD
            dcflags     : *DCFLAGS_WITH_HEADER_ZERO_PAD

    -   name: CpDcDefault16K32K
        testcase    : testcases.storage.ymltest2
        iterators   :
            type        : nested
            cpus        : *CPUS_ITER_LIST
            batch_depth : *BATCH_DEPTH_ITER_LIST
            mode        : *MODE_ITER_LIST
            blocksize   : [ *BLOCK_SIZE_16K, *BLOCK_SIZE_32K ]
        args    :
            test        : *CPDC_TEST_YML
            cpflags     : *CPFLAGS_DEFAULT
            dcflags     : *DCFLAGS_DEFAULT

    # PS-360
    -   name: CpDcDefault16K32KLargeBD
        testcase    : testcases.storage.ymltest2
        enable      : False
        ignore      : True
        iterators   :
            type        : nested
            cpus        : *CPUS_ITER_LIST
            batch_depth : *BATCH_DEPTH_LARGE_ITER_LIST
            mode        : *MODE_ITER_LIST
            blocksize   : [ *BLOCK_SIZE_16K, *BLOCK_SIZE_32K ]
        args    :
            test        : *CPDC_TEST_YML
            cpflags     : *CPFLAGS_DEFAULT
            dcflags     : *DCFLAGS_DEFAULT

    -   name: CpDcZeroPad16K32K
        testcase    : testcases.storage.ymltest2
        iterators   :
            type        : nested
            cpus        : *CPUS_ITER_LIST
            batch_depth : *BATCH_DEPTH_ITER_LIST_ZERO_PAD
            mode        : *MODE_ITER_LIST
            blocksize   : [ *BLOCK_SIZE_16K, *BLOCK_SIZE_32K ]
        args    :
            blocksize   : *BLOCK_SIZE_4K
            test        : *CPDC_TEST_YML
            cpflags     : *CPFLAGS_ZERO_PAD
            dcflags     : *DCFLAGS_ZERO_PAD

    -   name: CpDcZeroPad16K32KLargeBD
        testcase    : testcases.storage.ymltest2
        enable      : False
        ignore      : True
        iterators   :
            type        : nested
            cpus        : *CPUS_ITER_LIST
            batch_depth : *BATCH_DEPTH_LARGE_ITER_LIST_ZERO_PAD
            mode        : *MODE_ITER_LIST
            blocksize   : [ *BLOCK_SIZE_16K, *BLOCK_SIZE_32K ]
        args    :
            blocksize   : *BLOCK_SIZE_4K
            test        : *CPDC_TEST_YML
            cpflags     : *CPFLAGS_ZERO_PAD
            dcflags     : *DCFLAGS_ZERO_PAD

    -   name: CpDcWithHeader16K32K
        testcase    : testcases.storage.ymltest2
        iterators   :
            type        : nested
            cpus        : *CPUS_ITER_LIST
            batch_depth : *BATCH_DEPTH_ITER_LIST
            mode        : *MODE_ITER_LIST
            blocksize   : [ *BLOCK_SIZE_16K, *BLOCK_SIZE_32K ]
        args    :
            blocksize   : *BLOCK_SIZE_4K
            test        : *CPDC_TEST_YML
            cpflags     : *CPFLAGS_WITH_HEADER
            dcflags     : *DCFLAGS_WITH_HEADER

    -   name: CpDcWithHeader16K32KLargeBD
        testcase    : testcases.storage.ymltest2
        ignore      : True
        iterators   :
            type        : nested
            cpus        : *CPUS_ITER_LIST
            batch_depth : *BATCH_DEPTH_LARGE_ITER_LIST
            mode        : *MODE_ITER_LIST
            blocksize   : [ *BLOCK_SIZE_16K, *BLOCK_SIZE_32K ]
        args    :
            blocksize   : *BLOCK_SIZE_4K
            test        : *CPDC_TEST_YML
            cpflags     : *CPFLAGS_WITH_HEADER
            dcflags     : *DCFLAGS_WITH_HEADER

    -   name: CpDcWithHeaderZeroPad16K32K
        testcase    : testcases.storage.ymltest2
        enable      : False
        iterators   :
            type        : nested
            cpus        : *CPUS_ITER_LIST
            batch_depth : *BATCH_DEPTH_ITER_LIST_ZERO_PAD
            mode        : *MODE_ITER_LIST
            blocksize   : [ *BLOCK_SIZE_16K, *BLOCK_SIZE_32K ]
        args    :
            blocksize   : *BLOCK_SIZE_4K
            test        : *CPDC_TEST_YML
            cpflags     : *CPFLAGS_WITH_HEADER_ZERO_PAD
            dcflags     : *DCFLAGS_WITH_HEADER_ZERO_PAD

    -   name: CpDcWithHeaderZeroPad16K32KLargeBD
        testcase    : testcases.storage.ymltest2
        enable      : False
        ignore      : True
        iterators   :
            type        : nested
            cpus        : *CPUS_ITER_LIST
            batch_depth : *BATCH_DEPTH_LARGE_ITER_LIST_ZERO_PAD
            mode        : *MODE_ITER_LIST
            blocksize   : [ *BLOCK_SIZE_16K, *BLOCK_SIZE_32K ]
        args    :
            blocksize   : *BLOCK_SIZE_4K
            test        : *CPDC_TEST_YML
            cpflags     : *CPFLAGS_WITH_HEADER_ZERO_PAD
            dcflags     : *DCFLAGS_WITH_HEADER_ZERO_PAD

    -   name    : CompressFail
        testcase: testcases.storage.ymltest
        iterators:
            type        : nested
            mode        : *MODE_ITER_LIST
            blocksize   : [ *BLOCK_SIZE_4K, *BLOCK_SIZE_8K, *BLOCK_SIZE_16K, *BLOCK_SIZE_32K ]
        args    :
            dir     : *STORAGE_TEST_DIR
            wait    : 5 # Wait in seconds.
            cfg     : [ 4k.yml, globals.yml ]
            test    : cp_fail.yml
            failtest: True

    -   name    : DecompressFail
        testcase: testcases.storage.ymltest
        iterators:
            type        : nested
            mode        : *MODE_ITER_LIST
            blocksize   : [ *BLOCK_SIZE_4K, *BLOCK_SIZE_8K, *BLOCK_SIZE_16K, *BLOCK_SIZE_32K ]
        args    :
            dir     : *STORAGE_TEST_DIR
            wait    : 5 # Wait in seconds.
            cfg     : [ 4k.yml, globals.yml ]
            test    : dc_fail.yml
            failtest: True

    -   name        : Hash4K8K
        testcase    : testcases.storage.ymltest2
        ignore      : True
        iterators   :
            type        : nested
            cpus        : *CPUS_ITER_LIST
            batch_depth : *BATCH_DEPTH_ITER_LIST
            mode        : *MODE_ITER_LIST
            blocksize   : [ *BLOCK_SIZE_4K, *BLOCK_SIZE_8K ]
            flags       : *HASH_FLAGS_LIST
            algo        : *HASH_ALGO_LIST
        args    :
            wait        : 5
            test        : *HASH_TEST_YML

    -   name        : Hash16K32K
        testcase    : testcases.storage.ymltest2
        ignore      : True
        iterators   :
            type        : nested
            cpus        : *CPUS_ITER_LIST
            batch_depth : *BATCH_DEPTH_ITER_LIST
            mode        : *MODE_ITER_LIST
            blocksize   : [ *BLOCK_SIZE_16K, *BLOCK_SIZE_32K ]
            flags       : *HASH_FLAGS_LIST
            algo        : *HASH_ALGO_LIST
        args    :
            wait        : 5
            test        : *HASH_TEST_YML

    -   name        : Hash4K8KLargeBD
        testcase    : testcases.storage.ymltest2
        ignore      : True
        iterators   :
            type        : nested
            cpus        : *CPUS_ITER_LIST
            batch_depth : *BATCH_DEPTH_LARGE_ITER_LIST
            mode        : *MODE_ITER_LIST
            blocksize   : [ *BLOCK_SIZE_4K, *BLOCK_SIZE_8K ]
            flags       : *HASH_FLAGS_LIST
            algo        : *HASH_ALGO_LIST
        args    :
            wait        : 5
            test        : *HASH_TEST_YML

    -   name        : Hash16K32KLargeBD
        testcase    : testcases.storage.ymltest2
        ignore      : True
        iterators   :
            type        : nested
            cpus        : *CPUS_ITER_LIST
            batch_depth : *BATCH_DEPTH_LARGE_ITER_LIST
            mode        : *MODE_ITER_LIST
            blocksize   : [ *BLOCK_SIZE_16K, *BLOCK_SIZE_32K ]
            flags       : *HASH_FLAGS_LIST
            algo        : *HASH_ALGO_LIST
        args    :
            wait        : 5
            test        : *HASH_TEST_YML


    -   name        : Checksum4K8K
        testcase    : testcases.storage.ymltest2
        ignore      : True
        iterators   :
            type        : nested
            cpus        : *CPUS_ITER_LIST
            batch_depth : *BATCH_DEPTH_ITER_LIST
            mode        : *MODE_ITER_LIST
            blocksize   : [ *BLOCK_SIZE_4K, *BLOCK_SIZE_8K ]
            flags       : *CHKSUM_FLAGS_LIST
            algo        : *CHKSUM_ALGO_LIST
        args    :
            wait        : 5
            test        : *CHKSUM_TEST_YML

    -   name        : Checksum16K32K
        testcase    : testcases.storage.ymltest2
        ignore      : True
        iterators   :
            type        : nested
            cpus        : *CPUS_ITER_LIST
            batch_depth : *BATCH_DEPTH_ITER_LIST
            mode        : *MODE_ITER_LIST
            blocksize   : [ *BLOCK_SIZE_16K, *BLOCK_SIZE_32K ]
            flags       : *CHKSUM_FLAGS_LIST
            algo        : *CHKSUM_ALGO_LIST
        args    :
            wait        : 5
            test        : *CHKSUM_TEST_YML

    -   name        : Checksum4K8KLargeBD
        testcase    : testcases.storage.ymltest2
        ignore      : True
        iterators   :
            type        : nested
            cpus        : *CPUS_ITER_LIST
            batch_depth : *BATCH_DEPTH_LARGE_ITER_LIST
            mode        : *MODE_ITER_LIST
            blocksize   : [ *BLOCK_SIZE_4K, *BLOCK_SIZE_8K ]
            flags       : *CHKSUM_FLAGS_LIST
            algo        : *CHKSUM_ALGO_LIST
        args    :
            wait        : 5
            test        : *CHKSUM_TEST_YML

    -   name        : Checksum16K32KLargeBD
        testcase    : testcases.storage.ymltest2
        ignore      : True
        iterators   :
            type        : nested
            cpus        : *CPUS_ITER_LIST
            batch_depth : *BATCH_DEPTH_LARGE_ITER_LIST
            mode        : *MODE_ITER_LIST
            blocksize   : [ *BLOCK_SIZE_16K, *BLOCK_SIZE_32K ]
            flags       : *CHKSUM_FLAGS_LIST
            algo        : *CHKSUM_ALGO_LIST
        args    :
            wait        : 5
            test        : *CHKSUM_TEST_YML

#    -   name    : Crypto
#TBD TBD
#        testcase: testcases.storage.ymltest
#        enable  : False
#        iterators   :
#            type        : nested
#            cpus        : *CPUS_ITER_LIST
#            batch_depth : *BATCH_DEPTH_ITER_LIST
#            mode        : *MODE_ITER_LIST
#            blocksize   : [ *BLOCK_SIZE_4K, *BLOCK_SIZE_8K, *BLOCK_SIZE_16K, *BLOCK_SIZE_32K ]
#        args    :
#            dir : *STORAGE_TEST_DIR
#            wait: 5 # Wait in seconds.
#            cfg : [ 4k.yml, globals.yml ]
#            test: crypto1.yml
#
#    -   name    : CryptoFail
#        testcase: testcases.storage.ymltest
#        enable  : False
#TBD TBD
#        iterators:
#            mode        : *MODE_ITER_LIST
#            blocksize   : [ *BLOCK_SIZE_4K, *BLOCK_SIZE_8K, *BLOCK_SIZE_16K, *BLOCK_SIZE_32K ]
#        args    :
#            dir : *STORAGE_TEST_DIR
#            wait: 5 # Wait in seconds.
#            cfg : [ 4k.yml, globals.yml ]
#            test: crypto_fail.yml
#
#    -   name    : Test3
#        testcase: testcases.storage.ymltest
#TBD: Run only batch_depth 1, 16, 31 and 32
#        enable  : False
#        args    :
#            dir : *STORAGE_TEST_DIR
#            wait: 5 # Wait in seconds.
#            cfg : [ 4k.yml, globals.yml ]
#            test: test3.yml

teardown:
    #- step      : verif.utils.collect_logs_and_cores
