package apiserver

import (
	"context"

	"google.golang.org/grpc"

	"github.com/pensando/sw/utils/kvstore"
	"github.com/pensando/sw/utils/kvstore/store"
	"github.com/pensando/sw/utils/log"
	"github.com/pensando/sw/utils/runtime"
)

// ServiceBackend is the interface  satisfied by the module that is responsible for registering
//  services and messages. Each proto file constitutes a backend and multiple services may be handled
//  by one Backend and all needed code for operation of the backend is generated by the code generator.
type ServiceBackend interface {
	// CompleteRegistration is invoked after the API server is done initializing.
	CompleteRegistration(ctx context.Context, logger log.Logger, grpcserver *grpc.Server, scheme *runtime.Scheme) error
}

// ServiceHookCb is a callback registered with the ApiServer for the purpose of registering Hooks for services.
type ServiceHookCb func(srv Service, logger log.Logger)

// Server interface is implemented by the API server and used by the backends to register themselves
//  to the API server.
type Server interface {
	// Register is used by backends to register during init()
	Register(name string, svc ServiceBackend) (ServiceBackend, error)
	// RegisterMessages registers messages defined in a backend.
	RegisterMessages(svc string, msgs map[string]Message)
	// RegisterService registers a service with name in "name"
	RegisterService(name string, svc Service)
	// RegisterHooksCb registers a callback to register hooks for the service svcName
	RegisterHooksCb(svcName string, fn ServiceHookCb)
	// GetService returns a registered service given the name.
	GetService(name string) Service
	// Run starts the "eventloop" for the API server.
	Run(config Config)
}

// Config holds config for the API Server.
type Config struct {
	// Connection string for the KV store.
	Kvstore store.Config
	// GrpcServerPort is the port on which to start the API server service.
	GrpcServerPort string
	// grpcOptions is list of options to be passed into grpc
	grpcOptions []grpc.CallOption
	// DebugMode communicates whether the API server should be started in debug mode.
	// Starting in debug mode enables some features like calltraces in logs. Support for
	// getting a callstack snapshot with ^\ key patter.
	DebugMode bool
	// Logger is the logger to be used by the APi server and all registered backends for logging.
	Logger log.Logger
	// Version the API server should use as the native version.
	Version string
	Scheme  *runtime.Scheme
}

// TransformFunc is a function that tranforms a message from "from" version to the "to" version.
type TransformFunc func(from, to string, i interface{}) interface{}

// DefaulterFunc is a function that performs custom defaulting on the message.
type DefaulterFunc func(i interface{}) interface{}

// ValidateFunc is a function the validates the message. returns nil on success and error
//  when validation fails.
type ValidateFunc func(i interface{}) error

// PreCommitFunc is the registered function that is desired to be invoked before commit
// (the KV store operation). Multiple precommitFuncs could be registered. All registered funcs
// are called. Any of the precommit functions can provide feedback to skip the KV operation by
// returning False.
// Returning an error aborts processing of this API call.
type PreCommitFunc func(ctx context.Context, kvs kvstore.Interface, txn kvstore.Txn, key, oper string, i interface{}) (interface{}, bool, error)

// PostCommitFunc are registered functions that will be invoked after the KV store operation. Multiple
// functions could be registered and all registered functions are called.
type PostCommitFunc func(ctx context.Context, oper string, i interface{})

// ResponseWriterFunc is a function that is registered to provide a custom response to a API call.
// The ResponseWriterFunc can return a completely different type than the passed in message.
// In case of delete the "old" parameter contains the deleted object.
type ResponseWriterFunc func(ctx context.Context, kvs kvstore.Interface, prefix string, i interface{}, old interface{}, oper string) (interface{}, error)

// KeyGenFunc is a function that generates the key for input i. This is usually auto-generated code.
type KeyGenFunc func(i interface{}, prefix string) string

// UpdateKvFunc is the function to Update the KV store. Usually registered by generated code.
type UpdateKvFunc func(ctx context.Context, kvstore kvstore.Interface, i interface{}, prefix string, create bool) (interface{}, error)

// UpdateKvTxnFunc is the function to Update the object in a transaction. The transaction itself is applied via a txn.Commit()
// by the API server. Usually registered by generated code.
type UpdateKvTxnFunc func(ctx context.Context, kvstore kvstore.Txn, i interface{}, prefix string, create bool) error

// GetFromKvFunc is the function registered to retrieve from the KV store.
// Usually registered by generated code.
type GetFromKvFunc func(ctx context.Context, kvstore kvstore.Interface, key string) (interface{}, error)

// DelFromKvFunc is the function registered to delete from the KV store.
// Usually registered by generated code.
type DelFromKvFunc func(ctx context.Context, kvstore kvstore.Interface, key string) (interface{}, error)

// DelFromKvTxnFunc is the function registered to delete from a KV store transaction.
// Usually registered by generated code.
type DelFromKvTxnFunc func(ctx context.Context, kvstore kvstore.Txn, key string) error

// Message is the interface satisfied by the representation of the Message in the Api Server infra.
// A Message may be the definition of parameters passed in and out of a gRPC method or an object that
// is persisted in the KV store.
// The interface is a collection of Registration functions to register plugins and a set of Actions
// exposed by the Message.
type Message interface {
	MessageRegistration
	MessageAction
}

// MessageRegistration is the set of plugins that can be registered.
type MessageRegistration interface {
	// WithTransform registers a transform function between "from and "to" versions
	WithTransform(from, to string, fn TransformFunc) Message
	// WithValidate registers a custom validation function
	WithValidate(fn ValidateFunc) Message
	// WithDefaulter registers a custom defaulting function
	WithDefaulter(fn DefaulterFunc) Message
	// WithKeyGenerator registers a key generator function.
	WithKeyGenerator(fn KeyGenFunc) Message
	// WithKVUpdater registers a function to update the KV store
	WithKvUpdater(fn UpdateKvFunc) Message
	// WithKvTxnUpdater registers a function to update the KV store via a transaction.
	WithKvTxnUpdater(fn UpdateKvTxnFunc) Message
	// WithKvGetter registers a function that retrieves the message from kv store.
	WithKvGetter(fn GetFromKvFunc) Message
	// WithKvDelFunc registers a function that deletes a message from the KV store.
	WithKvDelFunc(fn DelFromKvFunc) Message
	// WithKvTxnDelFunc registers a function that deletes a message from the KV store via a transaction.
	WithKvTxnDelFunc(fn DelFromKvTxnFunc) Message
}

// MessageAction is the set of the Actions possible on a Message.
type MessageAction interface {
	// GetKind returns the kind of this message.
	GetKind() string
	// GetKvKey returns the KV store key for this message.
	GetKVKey(i interface{}, prefix string) (string, error)
	// WriteToKv writes the object to KV store. If create flag is set then the object
	// must not exist for success.
	WriteToKv(ctx context.Context, i interface{}, prerfix string, create bool) (interface{}, error)
	// WriteToKvTxn writes the object to the KV store Transaction. Actual applying of the transaction via
	// a Commit() happens elsewhere.
	WriteToKvTxn(ctx context.Context, txn kvstore.Txn, i interface{}, prerfix string, create bool) error
	// GetFromKv retrieves an object from the KV Store.
	GetFromKv(ctx context.Context, key string) (interface{}, error)
	// DelFromKv deletes an object from the KV store.
	DelFromKv(ctx context.Context, key string) (interface{}, error)
	// DelFromKvTxn deletes an object from the KV store as part of a transaction.
	DelFromKvTxn(ctx context.Context, txn kvstore.Txn, key string) error
	// PrepareMsg prepares the message to the "to" version by applying any transforms needed.
	PrepareMsg(from, to string, i interface{}) (interface{}, error)
	// Default applies the custom defaulter if registered.
	Default(i interface{}) interface{}
	// Validate validates the message by invoking the custom validation function registered.
	Validate(i interface{}) error
}

// Method is the interface satisfied by the representaion of the RPC Method in the API Server infra.
// A Method denotes a gRPC method or a REST resource with a set of exposed operations.
// This interface is a combination of Registration functions for plugins and a set of Actions
// allowed on the Method object.
type Method interface {
	MethodRegistration
	MethodAction
}

// MethodRegistration is the set of plugins that can be registered.
type MethodRegistration interface {
	// With PreCommitHook registeres fn to be called at pre-commit time.
	WithPreCommitHook(fn PreCommitFunc) Method
	// WithPostCommitHook registers tn to be invoked after the commit operation.
	WithPostCommitHook(fn PostCommitFunc) Method
	// WithResponseWriter registers a custom response generator for the method.
	WithResponseWriter(fn ResponseWriterFunc) Method
	// WithOper sets the CRUD operation for the method.
	WithOper(oper string) Method
	// With Version sets the version of the API
	WithVersion(ver string) Method
}

// MethodAction is the set of actions on a Method.
type MethodAction interface {
	// Enable enables the Methods for operation.
	Enable()
	// Disable disables the method from being invoked.
	Disable()
	// GetRequestType returns input type for the method.
	GetRequestType() Message
	// GetResponseType retuns the output type of the method.
	GetResponseType() Message
	// HandleInvcation handles the invocation of this method.
	HandleInvocation(ctx context.Context, i interface{}) (interface{}, error)
}

// Service interface is satisfied by all services registered with the API Server.
type Service interface {
	// Disable disables the Service
	Disable()
	// Enable enables the Service and all its methods.
	Enable()
	// GetMethod returns the Method object registered given its name. Returns nil when not found
	GetMethod(t string) Method
	// AddMethod add a method to the list of methods served by the Service.
	AddMethod(n string, m Method) Method
}
