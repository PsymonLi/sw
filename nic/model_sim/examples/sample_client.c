//  Hello World client
#include <zmq.h>
#include <string.h>
#include <stdio.h>
#include <unistd.h>
#include <assert.h>
#include "buf_hdr.h"
#include <stdio.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <cstdlib>
#include <assert.h>
#include <iostream>
#include "lib_model_client.h"


int main (void)
{
    lib_model_connect();
    /* Sample pkt 1 */
    //uint8_t pkt[] = {0x04, 0xDE, 0xFF, 0xDF, 0xFA, 0x4A, 0x02, 0xF8, 0xBD, 0xBD, 0x46, 0xAF, 0x0B, 0x2B, 0xE4, 0xC5, 0x22, 0xCD, 0x83, 0xD8, 0x0B, 0x3B, 0x49, 0xC2, 0x8B, 0x37, 0xB8, 0xCD, 0x4D, 0x35, 0xA4, 0x60, 0x65, 0x0A, 0xBE, 0xAD, 0xAB, 0xC6, 0x06, 0x29, 0x98, 0x2C, 0x35, 0xB6, 0xB7, 0x3E, 0x6E, 0xB1, 0xCC, 0x3B, 0xA8, 0xB6, 0xCC, 0xA8, 0x9C, 0xD4, 0x1A, 0x80, 0xDB, 0x44, 0xAA, 0x97, 0x18, 0x6C, 0x8D, 0xD9, 0x0A, 0xE1, 0x14, 0x99, 0xDA, 0xD7, 0xE7, 0x3D, 0x9C, 0xEE, 0xE4, 0xCC, 0xCC, 0x5A, 0xCD, 0x83, 0x44, 0x18, 0x25, 0x7A, 0x98, 0x0C, 0xAA, 0x4A, 0xA4, 0x04, 0xB9, 0x95, 0x01, 0xE6, 0x94, 0x97, 0x05, 0x2A, 0xCA, 0x39, 0xE6, 0xDA, 0x59, 0x62, 0x63, 0x74, 0xd9, 0x46};
    //uint8_t pkt[] = {0x00, 0x22, 0x22, 0x22, 0x22, 0x22, 0x00, 0x33, 0x33, 0x33, 0x33, 0x33, 0x81, 0x00, 0x00, 0x02, 0x08, 0x00, 0x45, 0x00, 0x00, 0x3c, 0x3e, 0xef, 0x40, 0x00, 0x40, 0x06, 0xfd, 0xca, 0x7f, 0x00, 0x00, 0x01, 0x7f, 0x00, 0x00, 0x01, 0xde, 0x88, 0xa4, 0x11, 0xbb, 0xb5, 0xe2, 0xa0, 0x00, 0x00, 0x00, 0x00, 0xa0, 0x02, 0xff, 0xff, 0xfe, 0x30, 0x00, 0x00, 0x02, 0x04, 0xff, 0xd7, 0x04, 0x02, 0x08, 0x0a, 0x16, 0x38, 0xdc, 0x4f, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x03, 0x02};
    uint8_t pkt[] = {0x00, 0x22, 0x22, 0x22, 0x22, 0x22, 0x00, 0x33, 0x33, 0x33, 0x33, 0x33, 0x81, 0x00, 0x00, 0x02, 0x08, 0x00, 0x45, 0x00, 0x00, 0x3C, 0x3E, 0xEF, 0x40, 0x00, 0x40, 0x11, 0xFD, 0xCA, 0x40, 0x00, 0x00, 0x01, 0x40, 0x00, 0x00, 0x02, 0xB8, 0xA9, 0x00, 0x80, 0xBB, 0xB5, 0xE2, 0xA0, 0x00, 0x00, 0x00, 0x00, 0xA0, 0x02, 0xFF, 0xFF, 0xFE, 0x30, 0x00, 0x00, 0x02, 0x04, 0xFF, 0xD7, 0x04, 0x02, 0x08, 0x0A, 0x16, 0x38, 0xDC, 0x4F, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x03, 0x02};
    std::vector<uint8_t> opkt;
    uint32_t port = 0, cos = 0;
    
    std::vector<uint8_t> ipkt;
    ipkt.resize(sizeof(pkt));
    memcpy(ipkt.data(), pkt, sizeof(pkt));
    std::cout << "Sending packet to model! size: " << ipkt.size() << " on port: " << port << std::endl;
    step_network_pkt(ipkt, port);
    
    get_next_pkt(opkt, port, cos);
    if (!opkt.size()) {
        std::cout << "NO packet back from model! size: " << opkt.size() << std::endl;
        exit(1);
    } else {
        std::cout << "Got packet back from model! size: " << opkt.size() << " on port: " << port << " cos: " << cos << std::endl;
        if (ipkt.size() == opkt.size()) {
            exit(0);
        } else {
            exit(1);
        }
    }

#if 0
    write_reg(0x3400000+0x8010, 0xbadabc);
    uint32_t data;
    read_reg(0x3400000+0x8010, data);
    printf("read_reg data: 0x%x\n", data);

    uint8_t mdata[4096];
    memset(mdata, 0xff, 4096);
        write_mem(0x80000000 , mdata, 176);
        write_mem(0x800000b0 , mdata, 328);
        write_mem(0x800001f8 , mdata, 184);
        write_mem(0x800002b0 , mdata, 160);
        write_mem(0x80000350 , mdata, 456);
        write_mem(0x80000518 , mdata, 112);
        write_mem(0x80000588 , mdata, 104);
        write_mem(0x800005f0 , mdata, 72 );
        write_mem(0x80000638 , mdata, 80 );
        write_mem(0x80000688 , mdata, 160);
        write_mem(0x80000728 , mdata, 144);
        write_mem(0x800007b8 , mdata, 240);
        write_mem(0x800008a8 , mdata, 256);
        write_mem(0x800009a8 , mdata, 832);
        write_mem(0x80000ce8 , mdata, 104);
        write_mem(0x80000d50 , mdata, 104);
        write_mem(0x80000db8 , mdata, 160);
        write_mem(0x80000e58 , mdata, 560);
#endif

    lib_model_conn_close();

    return 0;
}
