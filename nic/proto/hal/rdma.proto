//------------------------------------------------------------------------------
// protobuf specification for RDMA HAL APIs
//------------------------------------------------------------------------------

syntax = "proto3";

import "types.proto";
option go_package="halproto";

package rdma;

// Interface service definition
service Rdma {
  // Queue Pair related APIs
  rpc RdmaQpCreate(RdmaQpRequestMsg) returns (RdmaQpResponseMsg) {}
  rpc RdmaQpUpdate(RdmaQpUpdateRequestMsg) returns (RdmaQpUpdateResponseMsg) {}

  rpc RdmaAhCreate(RdmaAhRequestMsg) returns (RdmaAhResponseMsg) {}
  
  // Completion Q related APIs
  rpc RdmaCqCreate(RdmaCqRequestMsg) returns (RdmaCqResponseMsg) {}

  // Completion Q related APIs
  rpc RdmaEqCreate(RdmaEqRequestMsg) returns (RdmaEqResponseMsg) {}

  // Register Memory related APIs
  rpc RdmaMemReg(RdmaMemRegRequestMsg) returns (RdmaMemRegResponseMsg) {}
}

// types of interfaces
enum RdmaServiceType {
    RDMA_SERV_TYPE_RC          = 0;  // Reliable Connection
    RDMA_SERV_TYPE_UC          = 1;  // UnReliable Connection
    RDMA_SERV_TYPE_RD          = 2;  // Reliable Datagram
    RDMA_SERV_TYPE_UD          = 3;  // UnReliable Datagram
    RDMA_SERV_TYPE_CNP         = 4;  // Congestion Notification Pkt
    RDMA_SERV_TYPE_XRC         = 5;  // Extended Reliable Connection
    RDMA_SERV_TYPE_VEND_1      = 6;  // Vendor-1
    RDMA_SERV_TYPE_VEND_2      = 7;  // Vendor-2
}

//**********************    Queue Pair  ********************************//
// RdmaQp object
message RdmaQpSpec {
  types.ObjectMeta         meta            = 1;    // object meta
  uint32                   qp_num          = 2;    // qp number
  uint32                   hw_lif_id       = 3;    // hw lif id
  uint32                   sq_wqe_size     = 4;    // SQWQE size
  uint32                   rq_wqe_size     = 5;    // RQWQE size
  uint32                   num_sq_wqes     = 6;    // Num SQWQEs
  uint32                   num_rq_wqes     = 7;    // Num RQWQEs
  uint32                   num_rsq_wqes    = 8;    // Num RSQWQEs
  uint32                   num_rrq_wqes    = 9;    // Num RRQWQEs
  uint32                   pd              = 10;   // Protection domain
  uint32                   pmtu            = 11;   // Path MTU
  uint32                   hostmem_pg_size = 12;   // Host Memory Page Size
  RdmaServiceType          svc             = 13;   // RDMA service type
  bool                     atomic_enabled  = 14;   // enable Atomic Ops
  uint32                   sq_lkey         = 15;   // SQ's lkey
  uint32                   rq_lkey         = 16;   // RQ's lkey
  uint32                   rq_cq_num       = 17;   // RQ's CQ Number
  uint32                   sq_cq_num       = 18;   // SQ's CQ Number
  bool                     immdt_as_dbell  = 19;   // Use immdt data to ring dbell
  fixed64                  if_handle       = 20;   // EP's/ENIC's interface handle
}

// RdmaQpRequestMsg is batched request used to create/update of Rdma QPs
message RdmaQpRequestMsg {
  repeated RdmaQpSpec    request = 1;    // batch of requests
}

// RdmaQpResponse response to one RdmaQpSpec
message RdmaQpResponse {
  types.ApiStatus     api_status       = 1;    // API status code
  //RdmaQpStatus        status           = 2;    // operational status
  uint32              rsq_base_addr    = 3;    // RSQ base addr
  uint32              rrq_base_addr    = 4;    // RRQ base addr
  uint32              header_temp_addr = 5;    // Header template addr
}

// RdmaQpResponseMsg is response to RdmaQpRequestMsg
message RdmaQpResponseMsg {
  repeated RdmaQpResponse    response = 1;    // batch of responses
}

// types of Update QP operations
enum RdmaQpUpdateOper {
    RDMA_UPDATE_QP_OPER_SET_DEST_QP    = 0;  // Dest QP
    RDMA_UPDATE_QP_OPER_SET_HEADER_TEMPLATE = 1;  // L2/L3 Header Params
    RDMA_UPDATE_QP_OPER_SET_Q_KEY = 2; // Q_KEY
}
 
//****************   Update Queue Pair  ********************************//
// RdmaQpUpdate object
message RdmaQpUpdateSpec {
  types.ObjectMeta         meta            = 1;    // object meta
  uint32                   qp_num          = 2;    // QP number
  uint32                   hw_lif_id       = 3;    // hw lif id
  RdmaQpUpdateOper         oper            = 4;    // type of Update operation
  uint32                   dst_qp_num      = 5;    // Dest QP value
  bytes                    header_template = 6;    // Header Vector Params
  uint32                   q_key           = 7;    // Q_KEY
}

// RdmaQpRequestMsg is batched request used to create/update of Rdma QPs
message RdmaQpUpdateRequestMsg {
  repeated RdmaQpUpdateSpec    request = 1;    // batch of requests
}

// RdmaQpResponse response to one RdmaQpSpec
message RdmaQpUpdateResponse {
  types.ApiStatus     api_status       = 1;    // API status code
  //RdmaQpUpdateStatus        status           = 2;    // operational status
}

// RdmaQpUpdateResponseMsg is response to RdmaQpUpdateRequestMsg
message RdmaQpUpdateResponseMsg {
  repeated RdmaQpUpdateResponse    response = 1;    // batch of responses
}

//**********************    Address Handle  ********************************//
// RdmaAh object
message RdmaAhSpec {
  types.ObjectMeta         meta            = 1;    // object meta
  bytes                    smac            = 2;    // smac
  bytes                    dmac            = 3;    // dmac
  uint32                   ethtype         = 4;    // ipv4 or ipv6

  uint32                   vlan            = 5;
  uint32                   vlan_pri        = 6;
  uint32                   vlan_cfi        = 7;

  uint32                   ip_ver          = 8;
  uint32                   ip_tos          = 9;
  uint32                   ip_ttl          = 10;
  types.IPAddress          ip_saddr        = 11;
  types.IPAddress          ip_daddr        = 12;

  uint32                   udp_sport       = 13;
  uint32                   udp_dport       = 14;
}

// RdmaAhRequestmsg is batched request used to create/update of Rdma QPs
message RdmaAhRequestMsg {
  repeated RdmaAhSpec    request = 1;    // batch of requests
}

// RdmaAhResponse to one RdmaAhSpec
message RdmaAhResponse {
  types.ApiStatus     api_status       = 1;    // API status code
  uint32              ah_handle        = 2;    // Header template addr
  uint32              ah_size          = 3;    // Header template size
}

// RdmaAhResponseMsg is response to RdmaAhRequestmsg
message RdmaAhResponseMsg {
  repeated RdmaAhResponse    response = 1;    // batch of responses
}

//**********************   Completion Queue  *****************************//
// RdmaCq object
message RdmaCqSpec {
  types.ObjectMeta         meta            = 1;    // object meta
  uint32                   cq_num          = 2;    // CQ Number
  uint32                   hw_lif_id       = 3;    // LIF id
  uint32                   cq_wqe_size     = 4;    // CQWQE size
  uint32                   num_cq_wqes     = 5;    // Num CQWQEs
  uint32                   hostmem_pg_size = 7;    // Path MTU
  uint32                   cq_lkey         = 8;    // CQ's lkey
  uint32                   eq_id           = 9;    // EQ id
}

// RdmaCqRequestMsg is batched request used to create/update of Rdma QPs
message RdmaCqRequestMsg {
  repeated RdmaCqSpec    request = 1;    // batch of requests
}

// RdmaCqResponse response to one RdmaCqSpec
message RdmaCqResponse {
  types.ApiStatus     api_status       = 1;    // API status code
  //RdmaCqStatus        status           = 2;    // operational status
}

// RdmaCqResponseMsg is response to RdmaCqRequestMsg
message RdmaCqResponseMsg {
  repeated RdmaCqResponse    response = 1;    // batch of responses
}

//**********************   Event Queue  *****************************//
// RdmaEq object
message RdmaEqSpec {
  types.ObjectMeta         meta               = 1;    // object meta
  uint32                   eq_id              = 2;    // EQ Number
  uint32                   hw_lif_id          = 3;    // LIF id
  uint32                   eq_wqe_size        = 4;    // EQWQE size
  uint32                   num_eq_wqes        = 5;    // Num EQWQEs
  uint64                   eqe_base_addr_phy  = 6;    // EQE's base addres- physical
  uint32                   int_num            = 7;    // Interrupt num
}

// RdmaEqRequestMsg is batched request used to create/update of Rdma QPs
message RdmaEqRequestMsg {
  repeated RdmaEqSpec    request = 1;    // batch of requests
}

// RdmaEqResponse response to one RdmaEqSpec
message RdmaEqResponse {
  types.ApiStatus     api_status       = 1;        // API status code
  uint32              eq_intr_tbl_addr     = 2;    // EQ interrupt table addr
}

// RdmaEqResponseMsg is response to RdmaEqRequestMsg
message RdmaEqResponseMsg {
  repeated RdmaEqResponse    response = 1;    // batch of responses
}

//**********************   Memory Registratin(MR)  *********************//
// RdmaMemReg object
message RdmaMemRegSpec {
  types.ObjectMeta         meta            = 1;    // object meta
  uint64                   hw_lif_id       = 2;    // Hardware Lif Id
  uint32                   pd              = 3;    // Protection domain
  uint64                   va              = 4;    // Virtual address
  uint32                   len             = 5;    // Length of memory
  bool                     ac_local_wr     = 6;    // Acc control/permissions
  bool                     ac_remote_wr    = 7;    // Acc control/permissions
  bool                     ac_remote_rd    = 8;    // Acc control/permissions
  bool                     ac_remote_atomic= 9;    // Acc control/permissions
  uint32                   lkey            = 10;   // Lkey for this memory
  uint32                   rkey            = 11;   // Rkey for this memory
  uint32                   hostmem_pg_size = 12;   // Host Memory Page Size
  uint32                   override_lif    = 13;   // Override LIF value
  bool                     override_lif_vld  = 14; // Override LIF valid
  repeated uint64          va_pages_phy_addr = 15;  // Virtual memory pages's phy addr     
}

// RdmaMemRegRequestMsg is batched request used to create/update of Rdma QPs
message RdmaMemRegRequestMsg {
  repeated RdmaMemRegSpec    request = 1;    // batch of requests
}

// RdmaMemRegResponse response to one RdmaMemRegSpec
message RdmaMemRegResponse {
  types.ApiStatus     api_status       = 1;    // API status code
}

// RdmaMemRegResponseMsg is response to RdmaMemRegRequestMsg
message RdmaMemRegResponseMsg {
  repeated RdmaMemRegResponse    response = 1;    // batch of responses
}

