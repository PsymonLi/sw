//------------------------------------------------------------------------------
// protobuf specification for internal HAL APIs
//------------------------------------------------------------------------------

syntax = "proto3";

import "types.proto";
import "fwlog.proto";

package internal;
option go_package="halproto";

// Internal service definition
service Internal {
  // Program resolution related APIs
  rpc GetProgramAddress(GetProgramAddressRequestMsg) returns (ProgramAddressResponseMsg) {}
  // Program resolution related APIs
  rpc AllocHbmAddress(AllocHbmAddressRequestMsg) returns (AllocHbmAddressResponseMsg) {}
  // LIF BDF association APIs
  rpc ConfigureLifBdf(ConfigureLifBdfRequestMsg) returns (ConfigureLifBdfResponseMsg) {}
  // Inject a software PHV
  rpc SoftwarePhvInject (SoftwarePhvInjectMsg) returns (SoftwarePhvResponseMsg) {}
  // Get software PHV injection status
  rpc SoftwarePhvGet (SoftwarePhvGetRequestMsg) returns (SoftwarePhvGetResponseMsg) {}
  // Simulator service definition
  rpc LogFlow (LogFlowRequestMsg) returns (LogFlowResponseMsg) {}

  // Quiesce RPCs
  rpc QuiesceMsgSnd (EmptyRequest) returns (EmptyResponse) {}
  rpc QuiesceStart (EmptyRequest) returns (EmptyResponse) {}
  rpc QuiesceStop (EmptyRequest) returns (EmptyResponse) {}

  //IPsec
  rpc IpsecCbCreate (IpsecCbRequestMsg) returns (IpsecCbResponseMsg) {}
  rpc IpsecCbUpdate (IpsecCbRequestMsg) returns (IpsecCbResponseMsg) {}
  rpc IpsecCbDelete (IpsecCbDeleteRequestMsg) returns (IpsecCbDeleteResponseMsg) {}
  rpc IpsecCbGet (IpsecCbGetRequestMsg) returns (IpsecCbGetResponseMsg) {}

}

message ProgramAddressReq {
  // Handle. E.g.: 'iris', 'p4plus'.
  string handle = 1;

  // Program name to resolve
  string prog_name = 2;

  // If resolve_label is false, returns the base address of the program.
  // Otherwise returns the PC offset (14 bits) of the program.
  bool resolve_label = 3;

  // Label name to resolve
  string label = 4;
}

message ProgramAddressResp {
  int64 addr = 1;    // -errno, in case of error
}

message GetProgramAddressRequestMsg {
  repeated ProgramAddressReq request = 1;
}

message ProgramAddressResponseMsg {
  repeated ProgramAddressResp response = 1;
}

message HbmAddressReq {
  // handle that specifies region in config (json) file
  string handle = 1;
}

message HbmAddressResp {
  int64 addr = 1;    // -errno, in case of error
  uint32 size = 2;
}

message AllocHbmAddressRequestMsg {
  repeated HbmAddressReq request = 1;
}

message AllocHbmAddressResponseMsg {
  repeated HbmAddressResp response = 1;
}

message LifBdfReq {
  uint32 lif = 1;    
  uint32 bdf = 2;
}

message LifBdfResp {
  uint32 lif = 1;    
  uint32 bdf = 2;
  int32  status = 3;
}
message ConfigureLifBdfRequestMsg {
  repeated LifBdfReq request = 1;
}

message ConfigureLifBdfResponseMsg {
  repeated LifBdfResp response = 1;
}

// The Software PHV service definition
service SoftwarePhv {
}

// SoftwarePhvPipeline: pipeline to inject the software phv
enum SoftwarePhvPipeline {
  SOFTWARE_PHV_RXDMA       = 0;
  SOFTWARE_PHV_TXDMA       = 1;
  SOFTWARE_PHV_INGRESS     = 2;
  SOFTWARE_PHV_EGRESS      = 3;
}

// SoftwarePhvStatus represents the current status of the PHVs
message SoftwarePhvStatus {
  SoftwarePhvPipeline   pipeline          = 1;    // pipeline to inject into
  bool                  enabled           = 2;    // PHV injection is enabled
  bool                  done              = 3;    // PHV injection is done
  uint32                current_cntr      = 4;    // current counter
  uint32                inject_cntr       = 5;    // injected PHV counter
}

// SoftwarePhvResponse is generic response 
message SoftwarePhvResponse {
  types.ApiStatus       api_status        = 1 [(gogoproto.jsontag) = "api_status"];    // API status code
}

// SoftwarePhvResponseMsg is batched response to SoftwarePhvRequestMsg
message SoftwarePhvResponseMsg {
  repeated SoftwarePhvResponse    response = 1;    // batched response
}

// SoftwarePhvGetRequest is used to get information about a PHV
message SoftwarePhvGetRequest {
  SoftwarePhvPipeline   pipeline         = 1;    // pipeline to inject into
}

// SoftwarePhvGetRequestMsg is batched GET request for PHV
message SoftwarePhvGetRequestMsg {
  repeated SoftwarePhvGetRequest    request = 1;    // batched get request
}


// SoftwarePhvGetResponse captures all the information about a Sw PHV
// only if api_status indicates success, other fields are valid
message SoftwarePhvGetResponse {
  types.ApiStatus    api_status = 1 [(gogoproto.jsontag) = "api_status"];    // API status code
  SoftwarePhvStatus    status     = 2;    // operational state of PHV
}

// SoftwarePhvGetResponseMsg is the batched response to SoftwarePhvGetRequestMsg
message SoftwarePhvGetResponseMsg {
  repeated SoftwarePhvGetResponse    response = 1;    // batched get response
}

// SoftwarePhvInject is the packet inject spec
message SoftwarePhvInject {
  SoftwarePhvPipeline   pipeline         = 1;    // pipeline to inject into
}

// SoftwarePhvInjectMsg is the inject message
message SoftwarePhvInjectMsg {
  repeated SoftwarePhvInject  request = 1; // sw phv inject request
}

message LogFlowRequestMsg {
  repeated fwlog.FWEvent request = 1;
}

message LogFlowResponseMsg {
  repeated LogFlowResponse response = 1;
}

message LogFlowResponse {
  types.ApiStatus api_status  = 1 [(gogoproto.jsontag) = "api_status"];    // API status code
}

// Codegen forms the Request and Response messages using the package name "internal"
// This is to calm the autogenerator
message EmptyRequest{
  repeated types.Empty request = 1;
}

message EmptyResponse{
  repeated types.Empty response = 1;
}

// IpsecCbKeyHandle is used to operate on a ipsec_cb either by its key or handle
message IpsecCbKeyHandle {
  oneof key_or_handle {
    uint32     ipseccb_id          = 1;    // unique ipsec_cb id allocated by app                                                                                                                                                                                  
    fixed64    ipseccb_handle      = 2;    // ipsec_cb handle returned by HAL                                                                                                                                                                                      
  }                                                                                                                                                                                                                                                                
}                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                   
// IpsecCbSpec captures all the ipsec_cb level configuration                                                                                                                                                                                                       
message IpsecCbSpec {                                                                                                                                                                                                                                              
  IpsecCbKeyHandle      key_or_handle              = 1;    // ipsec_cb being created/updated                                                                                                                                                                       
  uint32                pi                    = 2;                                                                                                                                                                                                                 
  uint32                ci                    = 3;                                                                                                                                                                                                                 
  uint32                tunnel_sip4           = 4;                                                                                                                                                                                                                 
  uint32                tunnel_dip4           = 5;                                                                                                                                                                                                                 
  uint32                iv_size               = 6;                                                                                                                                                                                                                 
  uint32                icv_size              = 7;                                                                                                                                                                                                                 
  uint32                block_size            = 8;                                                                                                                                                                                                                 
  uint32                key_index             = 9;                                                                                                                                                                                                                 
  uint32                barco_enc_cmd         = 10;
  fixed64               iv                    = 11;
  uint32                iv_salt               = 12;
  uint32                esn_hi                = 13;
  uint32                esn_lo                = 14;
  uint32                spi                   = 15;
  uint32                expected_seq_no       = 16;
  fixed64               seq_no_bmp            = 17;
  types.IPAddress       sip6                  = 18;
  types.IPAddress       dip6                  = 19;
  uint32                is_v6                 = 20;
  uint32                vrf_vlan              = 21;
  uint32                last_replay_seq_no    = 22;
  uint32                new_spi               = 23;
  uint32                new_key_index         = 24;
  uint32                is_nat_t              = 25;
  uint32                flags                 = 26;
  uint32                is_random             = 27;
  uint32                extra_pad             = 28;
  uint32                rx_pkts               = 29;
  fixed64               rx_bytes              = 30;
  fixed64               rx_drops              = 31;
  fixed64               tx_pkts               = 32;
  fixed64               tx_bytes              = 33;
  fixed64               tx_drops              = 34;
}

// IpsecCbRequestMsg is batched add or modify ipseccb request
message IpsecCbRequestMsg {
  repeated IpsecCbSpec    request = 1;    // batched request
}

// IpsecCbStatus is the operational status of a given ipseccb
message IpsecCbStatus {
  fixed64    ipseccb_handle     = 1;    // id of ipseccb returned by HAL
}

// IpsecCbResponse is response to IpsecCbSpec
message IpsecCbResponse {
  types.ApiStatus        api_status            = 1;    // API status code
  IpsecCbStatus       ipseccb_status   = 2;    // ipseccb status, if api succeeded
}

// IpsecCbResponseMsg is batched response to IpsecCbRequestMsg
message IpsecCbResponseMsg {
  repeated IpsecCbResponse    response = 1;    // batched response
}

// IpsecCbDeleteRequest is used to delete a ipseccb
message IpsecCbDeleteRequest {
  IpsecCbKeyHandle     key_or_handle = 1;    // IpsecCb key or handle
}

// IpsecCbDeleteRequestMsg is used to delete a batch of ipseccbs
message IpsecCbDeleteRequestMsg {
  repeated IpsecCbDeleteRequest    request = 1;    // batched delete request
}

// IpsecCbDeleteResponseMsg is batched response to IpsecCbDeleteRequestMsg
message IpsecCbDeleteResponseMsg {
  repeated types.ApiStatus    api_status = 1;    // API status code
}

// IpsecCbGetRequest is used to get information about a ipseccb
message IpsecCbGetRequest {
  IpsecCbKeyHandle            key_or_handle = 1;    // IpsecCb key or handle
}

// IpsecCbGetRequestMsg is batched GET requests for ipseccbs
message IpsecCbGetRequestMsg {
  repeated IpsecCbGetRequest    request = 1;    // batched get request
}

// IpsecCbStats is the statistics object for each ipseccb
message IpsecCbStats {
}

// IpsecCbGetResponse captures all the information about a ipseccb
// only if api_status indicates success, other fields are valid
message IpsecCbGetResponse {
  types.ApiStatus        api_status = 1;    // API status code
  IpsecCbSpec         spec       = 2;    // ipseccb configuration
  IpsecCbStatus       status     = 3;    // operational state of ipseccb
  IpsecCbStats        stats      = 4;    // stats of the ipseccb
}

// IpsecCbGetResponseMsg is batched response to IpsecCbGetRequestMsg
message IpsecCbGetResponseMsg {
  repeated IpsecCbGetResponse    response = 1;    // batch get response
}

