//------------------------------------------------------------------------------
// {C} Copyright 2019 Pensando Systems Inc. All rights reserved
//
// protobuf specification for BGP
//
// NOTE: This is the netagent interface for BGP protocol configurations. This is
// a limited subset of configurations required for current deployments
//
//    This model supports the following BGP configuration level
//    hierarchy:
//
//      BGP
//        |
//        +-> [ global BGP configuration ]
//        +-> neighbor
//          +-> [ neighbor config ]
//          +-> AFI / SAFI [ per-AFI overrides ]";
//
//------------------------------------------------------------------------------

syntax = "proto3";
package pds;

import "pdsa.proto";
import "meta/meta.proto";
import "types.proto";
import "common.proto";

// The bgp service definition
service BGPSvc {
  rpc BGPGlobalSpecCreate (BGPRequest) returns (BGPResponse) {}
  rpc BGPGlobalSpecUpdate (BGPRequest) returns (BGPResponse) {}
  rpc BGPGlobalSpecDelete (BGPRequest) returns (BGPResponse) {}
  rpc BGPGlobalSpecGet (BGPRequest) returns (BGPGlobalSpecResponse) {}
  rpc BGPGlobalSpecGetAll (BGPRequest) returns (BGPGlobalSpecResponse) {}
  rpc BGPPeerSpecCreate (BGPPeerRequest) returns (BGPResponse) {}
  rpc BGPPeerSpecUpdate (BGPPeerRequest) returns (BGPResponse) {}
  rpc BGPPeerSpecDelete (BGPPeerRequest) returns (BGPResponse) {}
  rpc BGPPeerSpecGet (BGPPeerRequest) returns (BGPPeerSpecResponse) {}
  rpc BGPPeerSpecGetAll (BGPPeerRequest) returns (BGPPeerSpecResponse) {}
  rpc BGPPeerAfCreate (BGPPeerAfRequest) returns (BGPResponse) {}
  rpc BGPPeerAfUpdate (BGPPeerAfRequest) returns (BGPResponse) {}
  rpc BGPPeerAfDelete (BGPPeerAfRequest) returns (BGPResponse) {}
  rpc BGPPeerAfGet (BGPPeerAfRequest) returns (BGPPeerAfResponse) {}
  rpc BGPPeerAfGetAll (BGPPeerAfRequest) returns (BGPPeerAfResponse) {}
}

// BGP address family identifier
enum BGPAfi {
  BGP_AFI_NONE  = 0;
  BGP_AFI_IPV4  = 1;
  BGP_AFI_IPV6  = 2;
  BGP_AFI_L2VPN = 25;
}

// BGP sub-address family identitfier
enum BGPSafi {
  BGP_SAFI_NONE         = 0;
  BGP_SAFI_UNICAST      = 1;
  BGP_SAFI_MULTICAST    = 2;
  BGP_SAFI_BOTH         = 3;
  BGP_SAFI_LABEL        = 4;
  BGP_SAFI_VPLS         = 65;
  BGP_SAFI_EVPN         = 70;
  BGP_SAFI_MPLS_BGP_VPN = 128;
  BGP_SAFI_PRIVATE      = 241;
}

// BGP Peer RR Client
enum BGPPeerRRClient {
  BGP_NON_CLIENT    = 0;
  BGP_CLIENT        = 1;
  BGP_MESHED_CLIENT = 2;
}


// Global configuration for BGP
message BGPGlobalSpec {
  option (venice.pdsaSetGlobOpts) = {
      OidLen: "AMB_BGP_RM_OID_LEN",
      Mib:    "bgpRmEntTable"
      FillFn: "bgp_rm_ent_fill_func"
  };
  option (venice.pdsaGetGlobOpts) = {
      OidLen: "AMB_BGP_RM_OID_LEN",
      Mib:    "bgpRmEntTable"
  };
  // The local autonomous system number
  uint32  LocalASN = 1 [(venice.pdsaFields) = {Field: "local_as"}, (gogoproto.moretags) = "meta:mandatory"];
  // VRF id for this bgp instance
  uint32  VRFId    = 2 [(venice.pdsaFields) = {Field: "index", SetKeyOidIndex: "AMB_BGP_RM_INDEX_INDEX", GetKeyOidIndex: "AMB_BGP_RM_INDEX_INDEX"}, (gogoproto.moretags) = "meta:mandatory"];
  // Router ID for this bgp instance
  fixed32 RouterId = 3 [(venice.pdsaFields) = {Field: "local_identifier"}];
}

// BGPGlobalSpec create and update request
message BGPRequest {
  option (venice.pdsaSetGlobOpts) = {
      Mib: "bgpRmEntTable"
  };
  option (venice.pdsaGetGlobOpts) = {
      Mib: "bgpRmEntTable"
  };
  // requests
  repeated BGPGlobalSpec Request = 1;
}

// operational status of BGP, if any
message BGPStatus {
}

// BGPPeerSpec create and update request
message BGPPeerRequest {
  option (venice.pdsaSetGlobOpts) = {
      Mib: "bgpPeerTable"
  };
  option (venice.pdsaGetGlobOpts) = {
      Mib: "bgpPeerStatusTable"
  };
  // requests
  repeated BGPPeerSpec Request = 1;
}

// BGPPeerAf create and update request
message BGPPeerAfRequest {
  option (venice.pdsaSetGlobOpts) = {
      Mib: "bgpPeerAfiSafiTable"
  };
  option (venice.pdsaGetGlobOpts) = {
      Mib: "bgpPeerAfiSafiStatusTable"
  };
  // requests
  repeated BGPPeerAf Request = 1;
}

// BGPGlobalSpec create and update response
message BGPResponse {
  types.ApiStatus ApiStatus = 1;
  BGPStatus       Response  = 2;
}

// BGPGlobalSpec get response
message BGPGlobalSpecResponse {
  types.ApiStatus        ApiStatus = 1;
  repeated BGPGlobalSpec Response  = 2;
}

// BGPPeerSpec get response
message BGPPeerSpecResponse {
  types.ApiStatus      ApiStatus = 1;
  repeated BGPPeerSpec Response  = 2;
}

// BGPPeerAf get response
message BGPPeerAfResponse {
  types.ApiStatus     ApiStatus = 1;
  repeated BGPPeerAf  Response  = 2;
}

// BGP Peer configurations
message BGPPeerSpec {
  option (venice.pdsaSetGlobOpts) = {
      OidLen: "AMB_BGP_PER_OID_LEN",
      Mib:    "bgpPeerTable"
      FillFn: "bgp_peer_fill_func"
  };
  option (venice.pdsaGetGlobOpts) = {
      OidLen: "AMB_BGP_PRST_OID_LEN",
      Mib:    "bgpPeerStatusTable"
  };
  // The local autonomous system number
  uint32          LocalASN     = 1 [(venice.pdsaFields) = {Field: "conf_alt_local_as"}, (gogoproto.moretags) = "meta:mandatory"];
  // VRF id for this bgp instance
  uint32          VRFId        = 2 [(venice.pdsaFields) = {Field: "rm_ent_index", SetKeyOidIndex: "AMB_BGP_PER_RM_ENT_INDEX_INDEX", GetKeyOidIndex: "AMB_BGP_PRST_RM_ENT_INDEX_INDEX"}, (gogoproto.moretags) = "meta:mandatory"];
  // Whether BGP peer is enabled ? If peer is not enabled then
  // local router must not initiate connections to the neighbor
  // and must not respond to TCP connections attempts from
  // neighbor
  AdminSt         AdminEn      = 3 [(venice.pdsaFields) = {Field: "admin_status"}];
  // BGP Peer IP Address
  types.IPAddress PeerAddr     = 4 [(venice.pdsaFields) = {Field: "remote_addr"}, (gogoproto.moretags) = "meta:mandatory"];
  // BGP Peer Port Address
  uint32          PeerPort     = 5 [(venice.pdsaFields) = {Field: "remote_port", SetKeyOidIndex: "AMB_BGP_PER_REMOTE_PORT_INDEX", GetKeyOidIndex: "AMB_BGP_PRST_REMOTE_PORT_INDEX"}, (gogoproto.moretags) = "meta:mandatory"];
  // BGP Local IP Address
  types.IPAddress LocalAddr    = 6 [(venice.pdsaFields) = {Field: "local_addr"}, (gogoproto.moretags) = "meta:mandatory"];
  // BGP Local Port Address
  uint32          LocalPort    = 7 [(venice.pdsaFields) = {Field: "local_port", SetKeyOidIndex: "AMB_BGP_PER_LOCAL_PORT_INDEX", GetKeyOidIndex: "AMB_BGP_PRST_LOCAL_PORT_INDEX"}, (gogoproto.moretags) = "meta:mandatory"];
  // IfId
  uint32          IfId         = 8 [(venice.pdsaFields) = {Field: "local_addr_scope_id",  SetKeyOidIndex: "AMB_BGP_PER_SCOPE_ID_INDEX", GetKeyOidIndex: "AMB_BGP_PRST_SCOPE_ID_INDEX"}, (gogoproto.moretags) = "meta:mandatory"];
  // Remote 4-byte (32-bit) AS number
  uint32          RemoteASN    = 9 [(venice.pdsaFields) = {Field: "remote_as"}];
  // Send regular community attributes to neighbor
  AMBBool         SendComm     = 10 [(venice.pdsaFields) = {Field: "send_comm"}, (gogoproto.moretags) = "meta:default=false"];
  // Send extended community attributes to neighbor
  AMBBool         SendExtComm  = 11 [(venice.pdsaFields) = {Field: "send_ext_comm"}, (gogoproto.moretags) = "meta:default=false"];
  // Peer is a route reflector client
  BGPPeerRRClient RRClient     = 12 [(venice.pdsaFields) = {Field: "reflector_client"}, (gogoproto.moretags) = "meta:default=false"];
  // Update source address for peering
  types.IPAddress UpdateSrc    = 13;
  // BGP session connect-retry timer in seconds
  uint32          ConnectRetry = 14 [(venice.pdsaFields) = {Field: "connect_retry_interval"}, (gogoproto.moretags) = "range:1-65535"];
  // BGP session holdtime timer in seconds
  uint32          HoldTime     = 15 [(venice.pdsaFields) = {Field: "hold_time_configd"}, (gogoproto.moretags) = "range:0-0, 3-65535"];
  // BGP session keepalive timer in seconds
  uint32          KeepAlive    = 16 [(venice.pdsaFields) = {Field: "keep_alive_configd"}, (gogoproto.moretags) = "range:0-65535"];
}

// BGP PeerAF configurations
message BGPPeerAf {
  option (venice.pdsaSetGlobOpts) = {
      OidLen: "AMB_BGP_PAS_OID_LEN",
      Mib:    "bgpPeerAfiSafiTable"
  };
  option (venice.pdsaGetGlobOpts) = {
      OidLen: "AMB_BGP_PAST_OID_LEN",
      Mib:    "bgpPeerAfiSafiStatusTable"
  };
  // VRF id for this bgp instance
  uint32          VRFId       = 1 [(venice.pdsaFields) = {Field: "rm_ent_index",  SetKeyOidIndex: "AMB_BGP_PAS_RM_ENT_INDEX_INDEX", GetKeyOidIndex: "AMB_BGP_PAST_RM_ENT_INDEX_INDEX"}, (gogoproto.moretags) = "meta:mandatory"];
  // BGP Peer IP Address
  types.IPAddress PeerAddr    = 2 [(venice.pdsaFields) = {Field: "remote_addr"}, (gogoproto.moretags) = "meta:mandatory"];
  // BGP Peer Port Address
  uint32          PeerPort    = 3 [(venice.pdsaFields) = {Field: "remote_port",  SetKeyOidIndex: "AMB_BGP_PAS_REMOTE_PORT_INDEX", GetKeyOidIndex: "AMB_BGP_PAST_REMOTE_PORT_INDEX"}, (gogoproto.moretags) = "meta:mandatory"];
  // BGP Local IP Address
  types.IPAddress LocalAddr   = 4 [(venice.pdsaFields) = {Field: "local_addr"}, (gogoproto.moretags) = "meta:mandatory"];
  // BGP Local Port Address
  uint32          LocalPort   = 5 [(venice.pdsaFields) = {Field: "local_port",  SetKeyOidIndex: "AMB_BGP_PAS_LOCAL_PORT_INDEX", GetKeyOidIndex: "AMB_BGP_PAST_LOCAL_PORT_INDEX"}, (gogoproto.moretags) = "meta:mandatory"];
  // IfId
  uint32          IfId        = 6 [(venice.pdsaFields) = {Field: "local_addr_scope_id",  SetKeyOidIndex: "AMB_BGP_PAS_SCOPE_ID_INDEX", GetKeyOidIndex: "AMB_BGP_PAST_SCOPE_ID_INDEX"}, (gogoproto.moretags) = "meta:mandatory"];
  // BGP Address family
  BGPAfi          Afi         = 7 [(venice.pdsaFields) = {Field: "afi",  SetKeyOidIndex: "AMB_BGP_PAS_AFI_INDEX", GetKeyOidIndex: "AMB_BGP_PAST_AFI_INDEX"}];
  // BGP Sub-Address family
  BGPSafi         Safi        = 8 [(venice.pdsaFields) = {Field: "safi",  SetKeyOidIndex: "AMB_BGP_PAS_SAFI_INDEX", GetKeyOidIndex: "AMB_BGP_PAST_SAFI_INDEX"}];
  // Disable AFI SAFI
  AMBBool         Disable     = 9 [(venice.pdsaFields) = {Field: "disable_afi_safi"}];

  // Enforce this router to set self as next-hop for advertised routes
  AMBBool         NHself      = 10 [(venice.pdsaFields) = {Field: "next_hop_self"}];
  // Originate a default route to this peer
  AMBBool         DefaultOrig = 11 [(venice.pdsaFields) = {Field: "originate_default"}];
}
