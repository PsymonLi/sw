// Code generated by protoc-gen-grpc-pensando DO NOT EDIT.
 /*
 * Package cmd is a auto generated package.
 * Input file: {{.Name}}
 */
{{$cam := getMetaswitchMibTablesInfo}}
{{$pkgName := .Package}}
{{$fileName := .GetName}}
#include "nic/metaswitch/stubs/mgmt/pds_ms_ctm.hpp"
#include "nic/apollo/agent/svc/specs.hpp"
#include "nic/metaswitch/stubs/mgmt/gen/svc/{{TrimSuffix $fileName ".proto"}}_gen.hpp"
#include "nic/metaswitch/stubs/mgmt/gen/mgmt/pds_ms_{{TrimSuffix $fileName ".proto"}}_utils_gen.hpp"
#include "nic/metaswitch/stubs/mgmt/pds_ms_common.hpp"
#include "nic/metaswitch/stubs/mgmt/pds_ms_mgmt_utils.hpp"
#include "nic/metaswitch/stubs/mgmt/pds_ms_mgmt_state.hpp"

{{$file := .}}
{{range .Services}}
{{$svc := .}}
{{$svcname := .Name}}
{{range .Methods}}
{{$rpc := .Name}}
{{$requestTypeName := .RequestType.Name}}
{{$responseTypeName := .ResponseType.Name}}

Status
{{$svcname}}Impl::{{$rpc}}(ServerContext *context,
                              const {{$pkgName}}::{{.RequestType.Name}} *req,
                              {{$pkgName}}::{{.ResponseType.Name}} *resp) {
    if (req == NULL) {
        resp->set_apistatus(types::ApiStatus::API_STATUS_INVALID_ARG);
        return Status::CANCELLED;
    }

  {{if or (HasSuffix $rpc "Delete") (HasSuffix $rpc "Create") (HasSuffix $rpc "Update")}}
    try {
    uint correlator = PDS_MS_CTM_GRPC_CORRELATOR;
    PDS_MS_START_TXN(correlator);
    {{$fields := .RequestType.Fields}}
    {{range $fields}}
      {{$field := .}}
      {{if or (eq "request" .GetName) (eq "Request" .GetName)}}
        {{if isRepeatedField .}}
    for (int i = 0; i < req->request_size(); i ++) {
        auto proto_spec = req->request(i);
        {{else}}
        auto proto_spec = req->request();
        {{end}}
        {{if TypeIsMessage .}}
          {{$reqMsg := ($file.Reg.LookupMsg "" .GetTypeName)}}
          {{if hasExtension "venice.pdsaSetGlobOpts" $reqMsg}}
            {{$param := (getPdsaSetGlobalOpts $reqMsg $cam)}}
            {{$struct := $param.Struct}}
            {{if (HasSuffix $rpc "Delete")}}
        pds_ms_pre_set_{{$struct | ToLower}}(proto_spec, AMB_ROW_DESTROY, correlator);
        pds_ms_set_{{$struct | ToLower}}(proto_spec, AMB_ROW_DESTROY, correlator);
        pds_ms_post_set_{{$struct | ToLower}}(proto_spec, AMB_ROW_DESTROY, correlator);
            {{end}}
            {{if or (HasSuffix $rpc "Create") (HasSuffix $rpc "Update")}}
        pds_ms_pre_set_{{$struct | ToLower}}(proto_spec, AMB_ROW_ACTIVE, correlator);
        pds_ms_set_{{$struct | ToLower}}(proto_spec, AMB_ROW_ACTIVE, correlator);
        pds_ms_post_set_{{$struct | ToLower}}(proto_spec, AMB_ROW_ACTIVE, correlator);
            {{end}}
          {{end}}
        {{end}}
        {{if isRepeatedField .}}
    }
        {{end}}
      {{end}}
    {{end}}
    PDS_MS_END_TXN(correlator);
    } catch (const pds_ms::Error& e) {
        SDK_TRACE_ERR("CTM Transaction aborted %s", e.what());
        resp->set_apistatus(pds_ms_sdk_ret_to_api_status(e.rc()));
        return Status::OK;
    }
  {{end}}
 
  {{if or (HasSuffix $rpc "Get") (HasSuffix $rpc "GetAll")}}
    try {
    PDS_MS_GET_SHARED_START();
    {{$fields := .RequestType.Fields}}
    {{range $fields}}
      {{$field := .}}
      {{if or (eq "request" .GetName) (eq "Request" .GetName)}}
        {{if isRepeatedField .}}
    for (int i = 0; i < req->request_size(); i ++) {
        auto proto_spec = req->request(i);
        {{else}}
        auto proto_spec = req->request();
        {{end}}
        {{if TypeIsMessage .}}
          {{$reqMsg := ($file.Reg.LookupMsg "" .GetTypeName)}}
          {{if hasExtension "venice.pdsaGetGlobOpts" $reqMsg}}
            {{$param := (getPdsaGetGlobalOpts $reqMsg $cam)}}
            {{$struct := $param.Struct}}
            {{if (HasSuffix $rpc "Get")}}
        pds_ms_get_{{$struct | ToLower}}(proto_spec, resp);
            {{end}}
            {{if (HasSuffix $rpc "GetAll")}}
        pds_ms_getall_{{$struct | ToLower}}(proto_spec, resp);
            {{end}}
          {{end}}
        {{end}}
          {{if isRepeatedField .}}
    }
        {{end}}
      {{end}}
    {{end}}
    PDS_MS_GET_SHARED_END();
    } catch (const pds_ms::Error& e) {
        SDK_TRACE_ERR("MIB Get aborted %s", e.what());
        resp->set_apistatus(pds_ms_sdk_ret_to_api_status(e.rc()));
        return Status::OK;
    }
  {{end}}
    resp->set_apistatus(pds_ms::mgmt_state_t::ms_response_wait());
    return Status::OK;
} 

{{end}}
{{end}}
