// Code generated by protoc-gen-grpc-pensando DO NOT EDIT.
 /*
 * Package cmd is a auto generated package.
 * Input file: {{.Name}}
 */
{{$cam := getMetaswitchMibTablesInfo}}
{{$pkgName := .Package}}
{{$ExtPkgName := "pds"}}
{{$pkg := (joinFields $pkgName "." ".")}}
{{$fileName := .GetName}}
#include "nic/metaswitch/stubs/mgmt/pds_ms_ctm.hpp"
#include "nic/metaswitch/stubs/mgmt/gen/svc/{{TrimSuffix $fileName ".proto"}}_gen.hpp"
#include "nic/metaswitch/stubs/mgmt/gen/mgmt/pds_ms_{{TrimSuffix $fileName ".proto"}}_utils_gen.hpp"
#include "nic/metaswitch/stubs/mgmt/pds_ms_common.hpp"
#include "nic/metaswitch/stubs/mgmt/pds_ms_mgmt_utils.hpp"
#include "nic/metaswitch/stubs/mgmt/pds_ms_mgmt_state.hpp"

{{$file := .}}
{{range .Services}}
{{$svc := .}}
{{$svcname := .Name}}
{{range .Methods}}
{{$rpc := .Name}}
{{$requestTypeName := .RequestType.Name}}
{{$responseTypeName := .ResponseType.Name}}
{{$respMsg := .ResponseType}}
{{$respMsgName := .ResponseType.Name}}
{{if not (HasPrefix $fileName "internal_") }}
  {{$ExtPkgName = $pkgName}}
{{end}}


  {{if hasExtension "venice.pdsaSetGlobOpts" .RequestType }}
    {{$param := (getPdsaSetGlobalOpts .RequestType $cam)}}
    {{if not (eq $param.ActionFn "")}}
Status
{{$svcname}}Impl::{{$rpc}}(ServerContext *context,
                              const {{$ExtPkgName}}::{{.RequestType.Name}} *req,
                              {{$ExtPkgName}}::{{.ResponseType.Name}} *resp) {
    if (req == NULL) {
        resp->set_apistatus(types::ApiStatus::API_STATUS_INVALID_ARG);
        return Status::CANCELLED;
    }
    types::ApiStatus ret = types::API_STATUS_OK;
    {{if (HasSuffix $rpc "Create")}}
       PDS_TRACE_INFO("Received gRPC {{.RequestType.Name}} Create");
    {{end}}
    {{if (HasSuffix $rpc "Delete")}}
       PDS_TRACE_INFO("Received gRPC {{.RequestType.Name}} Delete");
    {{end}}
    {{if (HasSuffix $rpc "Update")}}
       PDS_TRACE_INFO("Received gRPC {{.RequestType.Name}} Update");
    {{end}}
    try {
    ret = {{$param.ActionFn}}(req, resp);
    } catch (const pds_ms::Error& e) {
        PDS_TRACE_ERR("MIB Get aborted %s", e.what());
        resp->set_apistatus(pds_ms_sdk_ret_to_api_status(e.rc()));
        return Status::OK;
    }
    resp->set_apistatus(ret);
    return Status::OK;
    {{end}}
  {{else}}
Status
{{$svcname}}Impl::{{$rpc}}(ServerContext *context,
                              const {{$ExtPkgName}}::{{.RequestType.Name}} *req,
                              {{$ExtPkgName}}::{{.ResponseType.Name}} *resp) {
    if (req == NULL) {
        resp->set_apistatus(types::ApiStatus::API_STATUS_INVALID_ARG);
        return Status::CANCELLED;
    }
    {{$pkgName}}::{{.ResponseType.Name}} proto_resp;
    types::ApiStatus ret = types::API_STATUS_OK;

    {{if (HasSuffix $rpc "Create")}}
       PDS_TRACE_INFO("Received gRPC {{.RequestType.Name}} Create");
    {{end}}
    {{if (HasSuffix $rpc "Delete")}}
       PDS_TRACE_INFO("Received gRPC {{.RequestType.Name}} Delete");
    {{end}}
    {{if (HasSuffix $rpc "Update")}}
       PDS_TRACE_INFO("Received gRPC {{.RequestType.Name}} Update");
    {{end}}
    {{if (HasSuffix $rpc "Get") }}
       PDS_TRACE_INFO("Received gRPC {{.RequestType.Name}} Update");
    {{end}}
    try {
    {{if or (HasSuffix $rpc "Delete") (HasSuffix $rpc "Create") (HasSuffix $rpc "Update")}}
    uint correlator = PDS_MS_CTM_GRPC_CORRELATOR;
    PDS_MS_START_TXN(correlator);
      {{$fields := .RequestType.Fields}}
      {{range $fields}}
        {{$field := .}}
        {{if or (eq "request" .GetName) (eq "Request" .GetName)}}
          {{if isRepeatedField .}}
    for (int i = 0; i < req->request_size(); i ++) {
        auto req_proto_spec = req->request(i);
          {{else}}
        auto req_proto_spec = req->request();
          {{end}}
          {{if TypeIsMessage .}}
            {{$reqMsg := ($file.Reg.LookupMsg "" .GetTypeName)}}
            {{if hasExtension "venice.pdsaSetGlobOpts" $reqMsg}}
              {{$param := (getPdsaSetGlobalOpts $reqMsg $cam)}}
              {{$struct := $param.Struct}}
              {{$specMsgName := $param.SpecMsg}}
              {{if (eq $specMsgName "")}}
                {{$specMsgName = (TrimPrefix .GetTypeName $pkg)}}
              {{end}}
              {{$updForDel := $param.UpdateForDelete}}
              {{$keyHandleReqName := (TrimPrefix .GetTypeName $pkg)}}
        {{$pkgName}}::{{$specMsgName}} proto_spec;
              {{if (HasSuffix $rpc "Delete")}}
        pds_ms_get_{{$specMsgName | ToLower}}_from_{{$keyHandleReqName | ToLower}}(req_proto_spec, proto_spec);
        pds_ms_pre_set_{{$struct | ToLower}}(proto_spec, AMB_ROW_DESTROY, correlator, &req_proto_spec);
        pds_ms_set_dump_{{$struct | ToLower}}(proto_spec);
                {{if $updForDel}}
        pds_ms_set_{{$struct | ToLower}}(proto_spec, AMB_ROW_ACTIVE, correlator, TRUE, TRUE);
                {{else}}
        pds_ms_set_{{$struct | ToLower}}(proto_spec, AMB_ROW_DESTROY, correlator, TRUE);
                {{end}}
        pds_ms_post_set_{{$struct | ToLower}}(proto_spec, AMB_ROW_DESTROY, correlator, &req_proto_spec);
              {{end}}
              {{if (HasSuffix $rpc "Create")}}
        pds_ms_ext_to_int_{{$specMsgName | ToLower}} (req_proto_spec, proto_spec);
        pds_ms_pre_set_{{$struct | ToLower}}(proto_spec, AMB_ROW_ACTIVE, correlator, &req_proto_spec);
        pds_ms_set_dump_{{$struct | ToLower}}(proto_spec);
        pds_ms_set_{{$struct | ToLower}}(proto_spec, AMB_ROW_ACTIVE, correlator, FALSE);
        pds_ms_post_set_{{$struct | ToLower}}(proto_spec, AMB_ROW_ACTIVE, correlator, &req_proto_spec);
              {{end}}
              {{if (HasSuffix $rpc "Update")}}
        pds_ms_ext_to_int_{{$specMsgName | ToLower}} (req_proto_spec, proto_spec);
        pds_ms_pre_set_{{$struct | ToLower}}(proto_spec, AMB_ROW_ACTIVE, correlator, &req_proto_spec, TRUE);
        pds_ms_set_dump_{{$struct | ToLower}}(proto_spec);
        pds_ms_set_{{$struct | ToLower}}(proto_spec, AMB_ROW_ACTIVE, correlator, FALSE, TRUE);
        pds_ms_post_set_{{$struct | ToLower}}(proto_spec, AMB_ROW_ACTIVE, correlator, &req_proto_spec, TRUE);
              {{end}}
            {{end}}
          {{end}}
          {{if isRepeatedField .}}
    }
          {{end}}
        {{end}}
      {{end}}
    PDS_MS_END_TXN(correlator);
    ret = pds_ms::mgmt_state_t::ms_response_wait();
    {{end}}
 
    {{if (HasSuffix $rpc "Get") }}
      {{$fields := .RequestType.Fields}}
      {{range $fields}}
        {{$field := .}}
        {{if or (eq "request" .GetName) (eq "Request" .GetName)}}
          {{$keyHandleReqName := (TrimPrefix .GetTypeName $pkg)}}
          {{if isRepeatedField .}}
        if (req->request_size()) {
            for (int i = 0; i < req->request_size(); i ++) {
                auto req_proto_spec = req->request(i);
          {{else}}
        if (req->has_request()) {
                auto req_proto_spec = req->request();
          {{end}}

          {{$respFields := $respMsg.Fields}}
          {{range $respFields}}
          {{$respField := .}}
            {{if or (eq "response" .GetName) (eq "Response" .GetName)}}
              {{if TypeIsMessage .}}
                {{$innerRespMsg := ($file.Reg.LookupMsg "" .GetTypeName)}}
                {{$innerRespFields := $innerRespMsg.Fields}}
                {{range $innerRespFields}}
                {{$innerRespField := .}}
                  {{if or (eq "spec" .GetName) (eq "Spec" .GetName)}}
                    {{$specMsg := ($file.Reg.LookupMsg "" .GetTypeName)}}
                    {{if hasExtension "venice.pdsaGetGlobOpts" $specMsg}}
                      {{$param := (getPdsaGetGlobalOpts $specMsg $cam)}}
                      {{$struct := $param.Struct}}
                      {{$specMsgName := $param.SpecMsg}}
                      {{if (eq $specMsgName "")}}
                        {{$specMsgName = (TrimPrefix .GetTypeName $pkg)}}
                      {{end}}
                {{$pkgName}}::{{$specMsgName}} proto_spec;
                pds_ms_get_{{$specMsgName | ToLower}}_from_{{$keyHandleReqName | ToLower}}(req_proto_spec, proto_spec);
                PDS_MS_GET_SHARED_START();
                pds_ms_pre_get_{{$struct | ToLower}}(proto_spec, &proto_resp, &req_proto_spec);
                pds_ms_get_dump_{{$struct | ToLower}}(proto_spec);
                pds_ms_get_{{$struct | ToLower}}(proto_spec, &proto_resp);
                pds_ms_post_get_{{$struct | ToLower}}(proto_spec, &proto_resp, &req_proto_spec);
                PDS_MS_GET_SHARED_END();
                ret = pds_ms::mgmt_state_t::ms_response_wait();
                    {{end}}
                  {{end}}
                  {{if or (eq "status" .GetName) (eq "Status" .GetName)}}
                    {{$statusMsg := ($file.Reg.LookupMsg "" .GetTypeName)}}
                    {{if hasExtension "venice.pdsaGetGlobOpts" $statusMsg}}
                      {{$param := (getPdsaGetGlobalOpts $statusMsg $cam)}}
                      {{$struct := $param.Struct}}
                      {{$specMsgName := $param.SpecMsg}}
                      {{$specType := getCppTypeFieldFromProto .Type .GetTypeName}}
                if (ret == types::API_STATUS_OK) {
                    {{$statusMsgHasNoKeys := true}}
                    {{range $statusMsg.Fields}}
                      {{if hasExtension "venice.pdsaFields" .}}
                        {{$fieldOpt := (getPdsaFieldOpt . $cam $struct)}}
                        {{if not (eq $fieldOpt.IsReadOnly true)}}
                          {{if (eq $fieldOpt.IsKey true) }}
                            {{$statusMsgHasNoKeys = false}}
                          {{end}}
                        {{end}}
                      {{end}}
                    {{end}}
                    {{if $statusMsgHasNoKeys}}
                    {{$pkgName}}::{{$specMsgName}} proto_status;
                    pds_ms_get_{{$specMsgName | ToLower}}_from_{{$keyHandleReqName | ToLower}}(req_proto_spec, proto_status);
                    {{else}}
                    {{$specType}} proto_status;
                    {{end}}
                    {{range $statusMsg.Fields}}
                      {{if hasExtension "venice.pdsaFields" .}}
                        {{$fieldOpt := (getPdsaFieldOpt . $cam $struct)}}
                        {{if not (eq $fieldOpt.IsReadOnly true)}}
                          {{if (eq $fieldOpt.IsKey true) }}
                            {{if (eq .GetTypeName ".types.IPAddress")}}
                    proto_status.set_allocated_{{$fieldOpt.Name | ToLower}}(new types::IPAddress(req_proto_spec.key().{{$fieldOpt.Name | ToLower}}()));
                            {{else}}
                              {{ if HasPrefix .GetTypeName ".pds_ms."}}
                    proto_status.set_{{$fieldOpt.Name | ToLower}}((pds_ms::{{TrimPrefix .GetTypeName ".pds_ms."}})req_proto_spec.key().{{$fieldOpt.Name | ToLower}}());
                              {{else}}
                    proto_status.set_{{.GetName | ToLower}}(req_proto_spec.key().{{.GetName | ToLower}}());
                              {{end}}
                            {{end}}
                          {{end}}
                        {{end}}
                      {{end}}
                    {{end}}  
                    PDS_MS_GET_SHARED_START();
                    pds_ms_pre_get_{{$struct | ToLower}}(proto_status, &proto_resp, &req_proto_spec);
                    pds_ms_get_{{$struct | ToLower}}(proto_status, &proto_resp);
                    pds_ms_post_get_{{$struct | ToLower}}(proto_status, &proto_resp, &req_proto_spec);
                    PDS_MS_GET_SHARED_END();
                    ret = pds_ms::mgmt_state_t::ms_response_wait();
                }
                    {{end}}
                  {{end}}
                {{end}}
                {{if hasExtension "venice.pdsaGetGlobOpts" $innerRespMsg}}
                  {{$param := (getPdsaGetGlobalOpts $innerRespMsg $cam)}}
                  {{$struct := $param.Struct}}
                  {{if (HasSuffix $rpc "Get")}}
                PDS_MS_GET_SHARED_START();
                pds_ms_pre_get_{{$struct | ToLower}}(proto_spec, &proto_resp);
                pds_ms_get_dump_{{$struct | ToLower}}(proto_spec);
                pds_ms_get_{{$struct | ToLower}}(proto_spec, &proto_resp);
                pds_ms_postget_{{$struct | ToLower}}(proto_spec, &proto_resp);
                PDS_MS_GET_SHARED_END();
                ret = pds_ms::mgmt_state_t::ms_response_wait();
                  {{end}}
                {{end}}
              {{end}}
            {{end}}
          {{end}}
          {{if isRepeatedField .}}
            }
          {{end}}
        } else {
            {{$respFields := $respMsg.Fields}}
            {{range $respFields}}
            {{$respField := .}}
              {{if or (eq "response" .GetName) (eq "Response" .GetName)}}
                {{if TypeIsMessage .}}
                  {{$innerRespMsg := ($file.Reg.LookupMsg "" .GetTypeName)}}
                  {{$innerRespFields := $innerRespMsg.Fields}}
                  {{range $innerRespFields}}
                  {{$innerRespField := .}}
                    {{if or (eq "spec" .GetName) (eq "Spec" .GetName)}}
                      {{$specMsg := ($file.Reg.LookupMsg "" .GetTypeName)}}
                      {{if hasExtension "venice.pdsaGetGlobOpts" $specMsg}}
                        {{$param := (getPdsaGetGlobalOpts $specMsg $cam)}}
                        {{$struct := $param.Struct}}
                PDS_MS_GET_SHARED_START();
                pds_ms_pre_getall_{{$struct | ToLower}}(&proto_resp);
                pds_ms_getall_{{$struct | ToLower}}(&proto_resp);
                pds_ms_post_getall_{{$struct | ToLower}}(&proto_resp);
                PDS_MS_GET_SHARED_END();
                ret = pds_ms::mgmt_state_t::ms_response_wait();
                      {{end}}
                    {{end}}
                    {{if or (eq "status" .GetName) (eq "Status" .GetName)}}
                      {{$statusMsg := ($file.Reg.LookupMsg "" .GetTypeName)}}
                      {{if hasExtension "venice.pdsaGetGlobOpts" $statusMsg}}
                        {{$param := (getPdsaGetGlobalOpts $statusMsg $cam)}}
                        {{$struct := $param.Struct}}
                PDS_MS_GET_SHARED_START();
                pds_ms_pre_getall_{{$struct | ToLower}}(&proto_resp);
                pds_ms_getall_{{$struct | ToLower}}(&proto_resp);
                pds_ms_post_getall_{{$struct | ToLower}}(&proto_resp);
                PDS_MS_GET_SHARED_END();
                ret = pds_ms::mgmt_state_t::ms_response_wait();
                      {{end}}
                    {{end}}
                  {{end}}
                  {{if hasExtension "venice.pdsaGetGlobOpts" $innerRespMsg}}
                    {{$param := (getPdsaGetGlobalOpts $innerRespMsg $cam)}}
                    {{$struct := $param.Struct}}
                PDS_MS_GET_SHARED_START();
                pds_ms_pre_getall_{{$struct | ToLower}}(&proto_resp);
                pds_ms_getall_{{$struct | ToLower}}(&proto_resp);
                pds_ms_post_getall_{{$struct | ToLower}}(&proto_resp);
                PDS_MS_GET_SHARED_END();
                ret = pds_ms::mgmt_state_t::ms_response_wait();
                  {{end}}
                {{end}}
              {{end}}
            {{end}}
        }
        {{end}}
      {{end}}
    {{end}}
    } catch (const pds_ms::Error& e) {
        PDS_TRACE_ERR("CTM Transaction aborted %s", e.what());
        resp->set_apistatus(pds_ms_sdk_ret_to_api_status(e.rc()));
        return Status::OK;
    }
    resp->set_apistatus(ret);

  {{if (HasSuffix $rpc "Get") }}
    pds_ms_convert_{{$respMsgName | ToLower}}_ext_response (proto_resp, resp);
  {{end}}
    return Status::OK;
  {{end}}
} //{{$svcname}}Impl::{{$rpc}} 

{{end}}
{{end}}
