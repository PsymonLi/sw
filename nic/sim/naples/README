
1. create a directory and copy naples-release-v1.tgz (call it install_dir)

2. cd install_dir

3. tar xvzf naples-release-v1.tgz

   once naples-release-v1.tgz is unzipped, you will find a Vagrantfile
   that is needed to VMs needed for simulating multiple data centers
   (each VM is a datacenter/kingdom)

   to create a VM needed to run NAPLES docker container. Note that
   only bare minimum packages needed to run NAPLES docker container
   are installed in this default Vagrantfile. Please feel free to add
   other packages that you may need to run your (native) apps, if any.

4. vagrant up

   This will bringup the datacenters and establish the VM connectivity between
   them. Additionally, each of the VMs will have NAPLES container running
   already with all the components of Pensando NIC. This container represents
   the NIC in the VPN gateway of that datacenter. Use 'vagrant ssh node1/node2'
   to connect to VMs

5. If you have to spin the NAPLES container manually (in case something went wrong),
   use 'docker start/stop naples-sim' inside the VMs.
   To do a fresh re-install of the naples container, re-provision the vargant VM
   using 'vagrant up --provision'

By default, port 9007 of the docker container is exposed to the host (i.e., VM
representing the datacenter) and hence REST APIs can be invoked using curl.

Examples:

In this example, we will use the pre-created "default" tenant. The following
config is to be posted on NAT VPN gateway in "kingdom-1".
Here 172.17.0.2 is IP address of the eth0 interface inside the NAPLES container.

Use default tenant:

curl 172.17.0.2:9007/api/tenants/
[{"kind":"Tenant","meta":{"name":"default","tenant":"default","namespace":"default","creation-time":"1970-01-01T00:00:00Z","mod-time":"1970-01-01T00:00:00Z"},"spec":{},"status":{"TenantID":1}}]

To use non-default tenant, do:

curl -d'{"Kind":"Tenant","meta":{"Name":"tenant-1"}}' -X POST -H "Content-Type: application/json" 172.17.0.2:9007/api/tenants/

Create Namespaces:

[vagrant@localhost:~]curl -d'{"Kind":"Namespace","meta":{"Name":"kingdom-1","Tenant":"default"}}' -X POST -H "Content-Type: application/json" 172.17.0.2:9007/api/namespaces/
[vagrant@localhost:~]curl -d'{"Kind":"Namespace","meta":{"Name":"kingdom-2","Tenant":"default"}}' -X POST -H "Content-Type: application/json" 172.17.0.2:9007/api/namespaces/
[vagrant@localhost:~]curl -d'{"Kind":"Namespace","meta":{"Name":"public","Tenant":"default"}}' -X POST -H "Content-Type: application/json" 172.17.0.2:9007/api/namespaces/

Create Network object for local Kingdom (kingdom-1) and "public" Network:

curl -d'{"Kind":"Network","meta":{"Name":"kingdom-1","Tenant":"default","Namespace":"kingdom-1"}, "spec:":{"IPv4Subet": "10.1.1.0/24", "IPv4Gateway":"10.1.1.1", "VlanID":100}}' -X POST -H "Content-Type: application/json" 172.17.0.2:9007/api/networks/

curl -d'{"Kind":"Network","meta":{"Name":"public","Tenant":"default","Namespace":"public"}, "spec:":{"IPv4Subet": "20.1.1.0/24", "IPv4Gateway":"20.1.1.1", "VlanID":200}}' -X POST -H "Content-Type: application/json" 172.17.0.2:9007/api/networks/

Create (remote) GW EPs:

curl -d'{"Kind":"Endpoint","Meta":{"Name":"kingdom1-router","Tenant":"default","Namespace":"kingdom-1"},"spec":{"NetworkName":"kingdom-1","Interface":"Uplink0"},"status":{"IPv4Address":"10.1.1.1/24","MacAddress":"00:22:22:22:22:22","NodeUUID":"GWUUID"}}' -X POST -H "Content-Type: application/json" localhost:9007/api/endpoints/

curl -d'{"kind":"Endpoint","Meta":{"Name":"public-router","Tenant":"default","Namespace":"public"},"spec":{"NetworkName":"public","Interface":"Uplink1"},"status":{"IPv4Address":"20.1.1.1/24","MacAddress":"00:33:33:33:33:33","NodeUUID":"GWUUID"}}' -X POST -H "Content-Type: application/json" localhost:9007/api/endpoints/

Create Routes:

curl -d'{"Kind":"Route","meta":{"Name":"kingdom-1","Tenant":"default","Namespace":"kingdom-1"}, "spec:":{"IPPrefix": "10.1.1.0/24", "GatewayIP":"10.1.1.1"}' -X POST -H "Content-Type: application/json" 172.17.0.2:9007/api/routes/
curl -d'{"Kind":"Route","meta":{"Name":"public","Tenant":"default","Namespace":"public"}, "spec:":{"IPPrefix": "20.1.1.0/24", "GatewayIP":"20.1.1.1"}' -X POST -H "Content-Type: application/json" 172.17.0.2:9007/api/routes/
curl -d'{"Kind":"Route","meta":{"Name":"kingdom-2","Tenant":"default","Namespace":"kingdom-2"}, "spec:":{"IPPrefix": "0.0.0.0/24", "Interface":"kingdom2-IPSecTunnel"}' -X POST -H "Content-Type: application/json" 172.17.0.2:9007/api/routes/
curl -d'{"Kind":"Route","meta":{"Name":"kingdom-3","Tenant":"default","Namespace":"kingdom-3"}, "spec:":{"IPPrefix": "0.0.0.0/24", "Interface":"kingdom3-IPSecTunnel"}' -X POST -H "Content-Type: application/json" 172.17.0.2:9007/api/routes/
...
...

Create NAT pool:

curl -d'{"kind":"NatPool","meta":{"name":"kingdom1-natpool","tenant":"default","namespace":"kingdom-1"},"spec":{"IPRange":"10.1.2.1-10.1.2.200"}' -X POST -H "Content-Type: application/json" localhost:9007/api/natpools/

Create NAT Mappings for remote services (running in kingdom-2):

TBD

Create NAT Policy:

TBD

Create NAT policy:

curl -d'{"kind":"NatPolicy","meta":{"name":"testNatPolicy","tenant":"tenant-1","namespace":"ns-1","creation-time":"1970-01-01T00:00:00Z","mod-time":"1970-01-01T00:00:00Z"},"spec":{"rules":[{"from":{"match-type":"IPRange","match":"10.0.0.0 - 10.0.1.0"},"to":{"match-type":"IPRange","match":"192.168.0.0 - 192.168.1.1"},"protocol":"","from-port":"","to-port":"","nat-pool":"preCreatedNatPool","action":"SNAT"}]},"status":{}}' -X POST -H "Content-Type: application/json" 172.17.0.2:9007/api/natpolicies/

Get all NAT policies:
curl 172.17.0.2:9007/api/natpolicies/ | jq .
[
  {
    "kind": "NatPolicy",
    "meta": {
      "name": "testNatPolicy",
      "tenant": "tenant-1",
      "namespace": "ns-1",
      "creation-time": "1970-01-01T00:00:00Z",
      "mod-time": "1970-01-01T00:00:00Z"
    },
    "spec": {
      "rules": [
        {
          "from": {
            "match-type": "IPRange",
            "match": "10.0.0.0 - 10.0.1.0"
          },
          "to": {
            "match-type": "IPRange",
            "match": "192.168.0.0 - 192.168.1.1"
          },
          "protocol": "",
          "from-port": "",
          "to-port": "",
          "nat-pool": "preCreatedNatPool",
          "action": "SNAT"
        }
      ]
    },
    "status": {
      "id": 1
    }
  }
]

