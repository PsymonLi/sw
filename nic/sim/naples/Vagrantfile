# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.require_version ">=1.9.5"

BOX_IMAGE = "venice/turin-centos74"

#default 2 nodes
DEFAULT_NODE_COUNT = 2
node_count = DEFAULT_NODE_COUNT

#user can control the number of vagrant nodes based on TURIN_NODE_COUNT env variable
if ENV['TURIN_NODE_COUNT'] then
    node_count = ENV["TURIN_NODE_COUNT"].to_i
end

DEFAULT_CPUS_PER_NODE = "2"
cpus_per_node = DEFAULT_CPUS_PER_NODE

DEFAULT_MEMORY_PER_NODE = 2048
memory_per_node = DEFAULT_MEMORY_PER_NODE


# number of CPUs per vagrant node is controilled by CPUS_PER_NODE env variable
if ENV["TURIN_CPUS_PER_NODE"] then
    cpus_per_node = ENV["TURIN_CPUS_PER_NODE"]
end

# Memory per vagrant node(unit is Megabytes) is controilled by CPUS_PER_NODE env variable
if ENV["TURIN_MEMORY_PER_NODE"] then
    memory_per_node = ENV["TURIN_MEMORY_PER_NODE"].to_i
end
 

NAPLES_VER = "v1"
NAPLES_IMAGE = "pensando/naples:#{NAPLES_VER}"
NAPLES_IMAGE_FILE = "naples-docker-#{NAPLES_VER}.tgz"
NAPLES_DATA_DIR = "/var/run/naples/"
NAPLES_OVERLAY_CONFIG_DIR="/home/vagrant/configs/config_vxlan_overlay"
NAPLES_IPSEC_CONFIG_DIR="/home/vagrant/configs/config_ipsec"
AGENT_PORT=9007
VENICE_IMAGE_FILE = "venice-sim.tar"

if File.exist?(NAPLES_IMAGE_FILE) == false

    unless Vagrant.has_plugin?("vagrant-docker-login")
      system("vagrant plugin install vagrant-docker-login")
      puts "vagrant-docker-login dependency installed, please try the command again"
      exit
    end

    unless ENV["DOCKER_USERNAME"] && ENV["DOCKER_PASSWORD"]
      puts "Please set your DOCKER_USERNAME, DOCKER_PASSWORD environment variables"
      exit
    end
end

Vagrant.configure("2") do |config|
  config.vm.box = BOX_IMAGE

  if !ENV['TURIN_DISABLE_NAPLES'] then
  (0..(node_count-1)).each do |i|
    config.vm.define "node#{i+1}" do |subconfig|
      subconfig.vm.hostname = "node#{i+1}"

      # data network (eth1)
      subconfig.vm.network :private_network, ip: "192.168.10.#{i+11}"

      # control network (eth2)
      subconfig.vm.network :private_network, ip: "0.0.0.0", virtualbox__intnet: "control_net", auto_config: false

      #agent port forwarding
      subconfig.vm.network  "forwarded_port", guest: AGENT_PORT, host: 9000+i+11

      subconfig.vm.provider "virtualbox" do |vb|
        vb.memory = memory_per_node
        vb.cpus = cpus_per_node
        vb.customize ['modifyvm', :id, '--nictype3', '82545EM']
        vb.customize ["modifyvm", :id, "--nicpromisc3", "allow-all"]
        vb.linked_clone = true # use base image and clone from it. for multi-VM, saves space
      end

      # install app docker images
      subconfig.vm.provision "docker" do |d|
        d.pull_images "networkstatic/iperf3"
      end
      if File.exist?(NAPLES_IMAGE_FILE) == false
          subconfig.vm.provision :docker_login
      end

      # one time setup
      subconfig.vm.provision "shell", inline: <<-SCRIPT
        sudo chmod a+rwx /var/run/docker.sock
        sudo chmod a+rwx /var/run/openvswitch/db.sock

        mkdir -p #{NAPLES_DATA_DIR}
        mkdir -p #{NAPLES_OVERLAY_CONFIG_DIR}
        mkdir -p #{NAPLES_IPSEC_CONFIG_DIR}
        if [ -f /vagrant/#{NAPLES_IMAGE_FILE} ]; then
          docker images purge
          docker rmi -f #{NAPLES_IMAGE} 2> /dev/null
          docker load --input /vagrant/#{NAPLES_IMAGE_FILE}
        else
          docker pull #{NAPLES_IMAGE}
        fi

        # create control network: macvlan docker net with 32 containers/node, 8 nodes/system
        if ! $(docker network inspect control-net &> /dev/null); then
          docker network create -d macvlan --subnet=11.1.1.0/24 --ip-range=11.1.1.#{32 + 32*i}/27 --gateway=11.1.1.254 -o parent=eth2 control-net
        fi

        # create ovs data network: ovs bridge: all nodes creates tunnel to node0 (hub)
        if ! $(ovs-vsctl br-exists data-net); then
          ovs-vsctl add-br data-net
        fi
      SCRIPT

      # provision data network tunnels
      if i == 0 then
        (0..(node_count-1)).each do |n1|
          if n1 != 0 then
            subconfig.vm.provision "shell" do |s|
              s.inline = "if ! $(ovs-vsctl show | grep vxtun-to &> /dev/null); then ovs-vsctl add-port data-net vxtun-to-node#{n1+1} -- set interface vxtun-to-node#{n1+1} type=vxlan options:key=11111 options:remote_ip=192.168.10.#{n1+11}; fi"
            end
          end
        end
      else
        subconfig.vm.provision "shell" do |s|
          s.inline = "if ! $(ovs-vsctl show | grep vxtun-to &> /dev/null); then ovs-vsctl add-port data-net vxtun-to-node1 -- set interface vxtun-to-node1 type=vxlan options:key=11111 options:remote_ip=192.168.10.11; fi"
        end
      end

      # bringup naples container
      subconfig.vm.provision "docker" do |d|
        d.run "naples-sim", image: NAPLES_IMAGE,
          args: "--privileged -p #{AGENT_PORT}:#{AGENT_PORT} --mount type=bind,source=#{NAPLES_DATA_DIR},target=/naples/data"
      end

      # Copy config samples and bootstrap script
      subconfig.vm.provision "shell", inline: <<-SCRIPT
        cp #{NAPLES_DATA_DIR}/examples/config_ipsec/Kingdom#{i+1}.postman_collection.json #{NAPLES_IPSEC_CONFIG_DIR}/postman_collection.json
        cp #{NAPLES_DATA_DIR}/examples/config_vxlan_overlay/Node#{i+1}.postman_collection.json #{NAPLES_OVERLAY_CONFIG_DIR}/postman_collection.json
        cp #{NAPLES_DATA_DIR}/examples/config_vxlan_overlay/Node#{i+1}.Delete.postman_collection.json #{NAPLES_OVERLAY_CONFIG_DIR}/postman_delete_collection.json
        cp #{NAPLES_DATA_DIR}/examples/postman_env.json /home/vagrant/configs/postman_env.json
        cp #{NAPLES_DATA_DIR}/examples/config_ipsec/README #{NAPLES_IPSEC_CONFIG_DIR}/README
        cp #{NAPLES_DATA_DIR}/examples/config_vxlan_overlay/README #{NAPLES_OVERLAY_CONFIG_DIR}/README
        cp #{NAPLES_DATA_DIR}/bootstrap.sh /usr/bin/naples-bootstrap.sh
        chmod +x /usr/bin/naples-bootstrap.sh

        # configure control-network for naples-sim
        ip link set up dev eth2
        ip link set dev eth1 mtu 9216
        if ! $(docker network inspect control-net | grep "naples-sim" &> /dev/null); then
          docker network connect control-net naples-sim
        fi

        sudo systemctl stop firewalld
        sudo setenforce 0
      SCRIPT

      # Run this on every boot

      #If user wants to mount their dircotry inside vagrant node then they need to set TURIN_DEV to 1 and TURIN_DEV_MOUNT_DIR to the directory path which needs to be mounted under the vagrant ndoe at /mnt/sw path
      if ENV["TURIN_DEV"] && ENV["TURIN_DEV"] == "1" then
          subconfig.vm.synced_folder ENV["TURIN_DEV_MOUNT_DIR"], "/mnt/sw"
      end

      subconfig.vm.provision "shell", run: 'always', inline: "/usr/bin/naples-bootstrap.sh $1", args: "#{i+1}"
    end
    end
  end

  if ENV['TURIN_ENABLE_VENICE'] then
      config.vm.define  "venice" do |subconfig|
          subconfig.vm.box = BOX_IMAGE
          subconfig.vm.box = "venice/centos74"
          subconfig.vm.box_version = "0.8"
          config.ssh.insert_key = false
          subconfig.vm.provision :shell, inline: 'ulimit -n 4096'
          subconfig.vm.hostname = "venice"

          # control network (eth1)
          subconfig.vm.network :private_network, ip: "0.0.0.0", virtualbox__intnet: "control_net", auto_config: false

          subconfig.vm.provider "virtualbox" do |vb|
              vb.memory = "4096"
              vb.cpus = 4
              vb.customize ['modifyvm', :id, '--nictype2', '82545EM']
              vb.customize ["modifyvm", :id, "--nicpromisc2", "allow-all"]
              vb.linked_clone = true # use base image and clone from it. for multi-VM, saves space
          end

          subconfig.vm.provision "shell", inline: <<-SCRIPT
            systemctl stop firewalld && systemctl disable firewalld
            systemctl stop chronyd && systemctl disable chronyd
            systemctl stop kubelet && systemctl disable kubelet
            setenforce 0
            usermod -a -G root vagrant
            usermod -a -G docker vagrant
            mkdir -p /etc/docker
            echo '{ "insecure-registries" : ["registry.test.pensando.io:5000"] }' > /etc/docker/daemon.json
            systemctl start docker
            systemctl enable docker
            ip link set up dev eth1
            sysctl -w vm.max_map_count=262144
            chmod 777 /var/run/docker.sock
          SCRIPT

          subconfig.vm.provision "shell", privileged: false, inline: <<-SCRIPT
              mkdir -p /home/vagrant/venice
              if [ -f /vagrant/#{VENICE_IMAGE_FILE} ]; then
                  cd /home/vagrant/venice
                  tar xvf /vagrant/#{VENICE_IMAGE_FILE}
              else
                  echo TODO download the venice sim binaries here with some credentials and extract the file
              fi
              /home/vagrant/venice/venice-bootstrap.sh
          SCRIPT
      end
  end
end
