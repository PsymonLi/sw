<div style="height:100%" class="alertsevents">
  <!-- Since we are resizing lazy rendered tables manually, it needs to be called
        when tabs change so it knows to resize itself -->
  <mat-tab-group fxFlex [disableRipple]="true"
                 (selectedIndexChange)="selectedIndexChangeEvent($event)">
    <mat-tab *roleGuard="'monitoringAlert_read'" label="ALERTS">
      <ng-container *ngTemplateOutlet="AlertsTableTemplate"></ng-container>
    </mat-tab>
    <mat-tab *roleGuard="'eventsevent_read'" label="EVENTS">
      <ng-container *ngTemplateOutlet="EventsTableTemplate"></ng-container>
    </mat-tab>
  </mat-tab-group>
</div>

<ng-template #EventsTableTemplate>
  <div fxFlex class="alertsevents-events-table">
    <app-lazyrender [data]="filteredEvents" [rows]="28" [virtualRowHeight]="36">
      <p-table #eventTable class="global-primeng-table-lazyload" [columns]="eventCols"
               [reorderableColumns]="true"
               dataKey="meta.name"
               [responsive]="true" sortField="meta.mod-time" [sortOrder]='-1'
               [loading]="eventsLoading"
               [resizableColumns]="true">
        <!-- Table Caption -->
        <ng-template pTemplate="caption">
          <div fxLayout="row" fxLayoutAlign="center center">
            <app-tableheader title="Events" [count]="filteredEvents.length"
                             [total]="eventsTotalCount"
                             [icon]="eventsIcon"
                             width="250px">
              <div fxFlex></div>
              <!-- All events are currently informational, so we do not display severity filters or search filter -->
              <!-- <div class="alertsevents-search" fxFlex="fxFlex" fxLayoutAlign="start center" > -->
              <!-- Find Event by:  -->
              <!-- <mat-form-field fxFlex="nogrow" floatLabel="never"> -->
              <!-- Max length is picked to be the same as Elastic search limit -->
              <!-- <input matInput [formControl]="eventSearchFormControl" placeholder="Leader, Service, ... " maxlength="256" autocomplete="off"> -->
              <!-- </mat-form-field> -->
              <!-- </div> -->
              <div *ngIf="selector && selector.eventSelector && selector.eventSelector.name"
                   class="alertsevents-filter-sourcenode">
                Filtering by {{selector.eventSelector.name}}
              </div>
              <!-- Removing the all button -->
              <!-- <div class="global-button global-alert-neutral alertsevents-main-menu-number alertsevents-disabled"
                  (click)="onEventNumberClick($event, null)" [matTooltip]="'All Events'"
                  *ngIf="currentEventSeverityFilter != null">All</div> -->
              <div class="global-button global-alert-critical alertsevents-main-menu-number "
                   [ngClass]="currentEventSeverityFilter != null && currentEventSeverityFilter !== 'critical' ? 'alertsevents-disabled' : ''"
                   (click)="onEventNumberClick($event, 'critical')" [matTooltip]="'Critical Events'"
                   *ngIf="eventNumbers.critical>0 && eventNumbers.critical !== events.length">
                {{ eventNumbers.critical }}</div>
              <div class="global-button global-alert-warning alertsevents-main-menu-number "
                   [ngClass]="currentEventSeverityFilter != null && currentEventSeverityFilter !== 'warn' ? 'alertsevents-disabled' : ''"
                   (click)="onEventNumberClick($event, 'warn')" [matTooltip]="'Warning Events'"
                   *ngIf="eventNumbers.warn>0 && eventNumbers.warn !== events.length">
                {{ eventNumbers.warn }}</div>
              <div class="global-button global-alert-info alertsevents-main-menu-number "
                   [ngClass]="currentEventSeverityFilter != null && currentEventSeverityFilter !== 'info' ? 'alertsevents-disabled' : ''"
                   (click)="onEventNumberClick($event, 'info')" [matTooltip]="'Infomational Events'"
                   *ngIf="eventNumbers.info>0 && eventNumbers.info !== events.length">
                {{ eventNumbers.info }}</div>
              <p-checkbox name="Show Debug Events" styleClass="alertsevents-checkbox"
                          labelStyleClass="alertsevents-checkbox-label" binary="true"
                          label="Show Debug Events"
                          [(ngModel)]="showDebugEvents" (onChange)="filterEvents()"></p-checkbox>
            </app-tableheader>
            <div fxFlex></div>
            <app-timerange fxFlex="nogrow" [selectedTimeRange]="eventsSelectedTimeRange"
                           (timeRange)="setEventsTimeRange($event)"></app-timerange>
          </div>
        </ng-template>
        <!-- colgroup config is need to enable column resize.  The "th" config needs pResizableColumn -->
        <ng-template pTemplate="colgroup" let-columns>
          <colgroup>
            <col *ngFor="let col of columns">
          </colgroup>
        </ng-template>
        <!-- Table Header -->
        <ng-template pTemplate="header" let-columns>
          <tr>
            <th *ngFor="let col of eventCols" [pSortableColumn]="col.sortable? col.field : ''"
                [class]="col.class" pResizableColumn pReorderableColumn>
              <app-sorticon [isSortable]="col.sortable" [field]="col.field">{{col.header}}
              </app-sorticon>
            </th>
          </tr>
        </ng-template>
        <!-- Table Body -->
        <ng-template pTemplate="body" let-rowData>
          <tr class="alertsevents-tablerow">
            <td *ngFor="let col of eventCols" [ngSwitch]="col.field" [class]="col.class">
              <div *ngSwitchCase="'meta.mod-time'">
                {{rowData.meta['mod-time'] | PrettyDate }}
              </div>
              <div *ngSwitchCase="'meta.creation-time'">
                {{rowData.meta['creation-time'] | PrettyDate }}
              </div>
              <ng-container *ngSwitchCase="'severity'">
                <mat-icon *ngIf="rowData.severity === 'critical'"
                          class="alertsevents-icon global-alert-critical-icon">
                  error</mat-icon>
                <mat-icon *ngIf="rowData.severity === 'warn'"
                          class="alertsevents-icon global-alert-warning-icon">error
                </mat-icon>
                <mat-icon *ngIf="rowData.severity === 'info'"
                          class="alertsevents-icon global-alert-info-icon">
                  notifications</mat-icon>
                <mat-icon *ngIf="rowData.severity === 'debug'"
                          class="alertsevents-icon global-alert-info-icon">
                  bug_report</mat-icon>
                <div style="display: inline; margin-left: 25px">
                  {{ severityEnum[rowData.severity] }} </div>
              </ng-container>
              <ng-container *ngSwitchCase="'object-ref'">
                <span *ngIf="rowData['object-ref'] != null" style="display: block">
                  {{ rowData['object-ref'].kind }} : {{ rowData['object-ref'].name }} </span>
              </ng-container>
              <ng-container *ngSwitchCase="'source'">
                <span *ngIf="rowData.source != null" style="display: block">
                  {{ rowData.source['node-name'] }} : {{ rowData.source.component }} </span>
              </ng-container>
              <ng-container *ngSwitchDefault>
                {{displayColumn(rowData, col)}}
              </ng-container>
            </td>
          </tr>
        </ng-template>

      </p-table>
    </app-lazyrender>
  </div>
</ng-template>

<ng-template #AlertsTableTemplate>
  <div fxFlex class="alertsevents-events-table">
    <app-lazyrender [data]="filteredAlerts" [rows]="28" [virtualRowHeight]="36" [runDoCheck]="true">
      <p-table #eventTable class="global-primeng-table-lazyload" [columns]="alertCols"
               [reorderableColumns]="true"
               [rowTrackBy]='alertTrackBy'
               [(selection)]="selectedAlerts" sortField="meta.mod-time" [sortOrder]='-1'
               dataKey="meta.name"
               [responsive]="true" [loading]="alertsLoading" [resizableColumns]="true">
        <!-- Table Caption -->
        <ng-template pTemplate="caption">
          <app-tableheader title="Alerts" [count]="filteredAlerts.length" [total]="alerts.length"
                           [icon]="alertsIcon" [enableColumnSelect]="false"
                           width="250px">
            <div fxFelx="none" class="">
              <mat-icon *ngIf="showBatchResolveIcon()" matTooltip="Resolve Selected Alerts"
                        class="global-table-action-icon"
                        (click)="resolveSelectedAlerts()">
                done_all
              </mat-icon>
              <mat-icon *ngIf="showBatchAcknowLedgeIcon()" matTooltip="Acknowledge Selected Alerts"
                        class="global-table-action-icon alertsevents-acknowledge-icon"
                        (click)="acknowledgeSelectedAlerts()">
                done
              </mat-icon>
              <mat-icon *ngIf="showBatchOpenIcon()" matTooltip="Mark Selected Alerts as Open"
                        class="global-table-action-icon alertsevents-open-icon"
                        (click)="openSelectedAlerts()">
                priority_high
              </mat-icon>
            </div>
            <div fxFlex></div>
            <div *ngIf="selector && selector.alertSelector && selector.alertSelector.name"
                 class="alertsevents-filter-sourcenode">
              Filtering by {{selector.alertSelector.name}}
            </div>
            <!-- Checkboxes for Open, Ack, Resolved states -->
            <div fxFlex="none" fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="10px">
              <ng-container *ngFor="let state of possibleFilterStates">
                <p-checkbox name="stateFilter" styleClass="alertsevents-checkbox"
                            labelStyleClass="alertsevents-checkbox-label" [value]="state"
                            [label]="state"
                            [disabled]="selectedStateFilters.length === 1 && selectedStateFilters[0] === state"
                            [(ngModel)]="selectedStateFilters" (onChange)="filterAlerts()">
                </p-checkbox>
              </ng-container>
            </div>
            <!-- Removing the all button -->
            <!-- <div class="global-button global-alert-neutral alertsevents-main-menu-number "
                 (click)="onAlertNumberClick(null)"  [matTooltip]="'All Alerts'"
                 *ngIf="currentAlertSeverityFilter != null">All</div> -->

            <div class="global-button global-alert-critical alertsevents-main-menu-number "
                 [ngClass]="currentAlertSeverityFilter != null && currentAlertSeverityFilter !== 'critical' ? 'alertsevents-disabled' : ''"
                 (click)="onAlertNumberClick('critical')" [matTooltip]="'Critical Alerts'"
                 *ngIf="alertNumbers.critical>0 && alertNumbers.critical !== alerts.length">
              {{ alertNumbers.critical }}</div>
            <div class="global-button global-alert-warning alertsevents-main-menu-number "
                 [ngClass]="currentAlertSeverityFilter != null && currentAlertSeverityFilter !== 'warn' ? 'alertsevents-disabled' : ''"
                 (click)="onAlertNumberClick('warn')" [matTooltip]="'Warning Alerts'"
                 *ngIf="alertNumbers.warn>0 && alertNumbers.warn !== alerts.length">
              {{ alertNumbers.warn }}</div>
            <div class="global-button global-alert-info alertsevents-main-menu-number "
                 [ngClass]="currentAlertSeverityFilter != null && currentAlertSeverityFilter !== 'info' ? 'alertsevents-disabled' : ''"
                 (click)="onAlertNumberClick('info')" [matTooltip]="'Infomational Alerts'"
                 *ngIf="(alertNumbers.info>0 && alertNumbers.info !== alerts.length)">
              {{ alertNumbers.info }}</div>
            &nbsp;|
            <app-timerange fxFlex="nogrow" [selectedTimeRange]="alertsSelectedTimeRange"
                           (timeRange)="setAlertsTimeRange($event)"></app-timerange>
          </app-tableheader>
        </ng-template>

        <!-- colgroup config is need to enable column resize.  The "th" config needs pResizableColumn -->
        <ng-template pTemplate="colgroup" let-columns>
          <colgroup>
            <col *ngFor="let col of columns">
          </colgroup>
        </ng-template>

        <!-- Table Header -->
        <ng-template pTemplate="header" let-columns>
          <tr>
            <th style="width: 3em" *ngIf="alertUpdatable">
              <p-tableHeaderCheckbox matTooltip="Select/Deselect All Records In Current Page">
              </p-tableHeaderCheckbox>
            </th>
            <th *ngFor="let col of alertCols" [pSortableColumn]="col.sortable? col.field : ''"
                pResizableColumn pReorderableColumn

                [class]="col.class"
                [colSpan]=" col.isLast ? 2 : 1">
              <app-sorticon [isSortable]="col.sortable" [field]="col.field">{{col.header}}
              </app-sorticon>
            </th>
          </tr>
        </ng-template>
        <!-- Table Body -->
        <ng-template pTemplate="body" let-rowData>
          <tr class="alertsevents-tablerow">
            <td *ngIf="alertUpdatable" style="width: 3em">
              <p-tableCheckbox [value]="rowData"></p-tableCheckbox>
            </td>
            <td *ngFor="let col of alertCols" [ngSwitch]="col.field" [class]="col.class">
              <div *ngSwitchCase="'meta.mod-time'" class="alertseventsrecord-date-row">
                {{rowData.meta['mod-time'] | PrettyDate }}
              </div>
              <div *ngSwitchCase="'meta.creation-time'" class="alertseventsrecord-date-row">
                {{rowData.meta['creation-time'] | PrettyDate }}
              </div>
              <ng-container *ngSwitchCase="'status.severity'">
                <mat-icon *ngIf="rowData.status.severity === 'critical'"
                          class="alertsevents-icon global-alert-critical-icon">error</mat-icon>
                <mat-icon *ngIf="rowData.status.severity === 'warn'"
                          class="alertsevents-icon global-alert-warning-icon">error</mat-icon>
                <mat-icon *ngIf="rowData.status.severity === 'info'"
                          class="alertsevents-icon global-alert-info-icon">
                  notifications</mat-icon>
                <div style="display: inline; margin-left: 25px">
                  {{ severityEnum[rowData.status.severity] }} </div>
              </ng-container>
              <div *ngSwitchCase="'status.source'">
                <div *ngIf="rowData.status.source != null" style="display: inline">
                  {{ rowData.status.source['node-name'] }} : {{ rowData.status.source.component }}
                </div>
              </div>
              <ng-container *ngSwitchDefault>
                {{displayColumn(rowData, col)}}
              </ng-container>
            </td>
            <td class="global-column-action">
              <div class="global-column-action-icon-container" fxLayout="row" fxLayoutGap="5px">
                <mat-icon *ngIf="alertUpdatable && rowData.spec.state !== 'resolved'"
                          matTooltip="Resolve Alert"
                          class="global-table-action-icon" (click)="resolveAlert(rowData)">
                  done_all
                </mat-icon>
                <mat-icon *ngIf="alertUpdatable && rowData.spec.state !== 'acknowledged'"
                          matTooltip="Acknowledge Alert"
                          class="global-table-action-icon alertsevents-acknowledge-icon"
                          (click)="acknowledgeAlert(rowData)">
                  done
                </mat-icon>
                <mat-icon *ngIf="alertUpdatable && rowData.spec.state !== 'open'"
                          matTooltip="Mark Alert as Open"
                          class="global-table-action-icon alertsevents-open-icon"
                          (click)="openAlert(rowData)">
                  priority_high
                </mat-icon>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </app-lazyrender>
  </div>
</ng-template>
