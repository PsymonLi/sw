<app-pagebody>
  <div fxFlex="auto" fxLayout="column" class="telemetry-page">
    <div fxFlex="50%" [style.min-height]="'300px'" fxLayout="row" class="telemetry-explore-top">
      <ng-container *ngTemplateOutlet="graph"></ng-container>
    </div>
    <div fxFlex="auto" fxLayout="column" class="telemetry-explore-bottom">
      <mat-tab-group fxFlex="auto" [disableRipple]="true" [(selectedIndex)]="activeTabNumber"
                     dynamicHeight>
        <mat-tab label="DATA SOURCES">
          <div fxFlex [style.height]="'100%'">
            <!-- Using ngIf here to force a redraw of this tabs contents
                  Otherwise, all elements that have an animation on them render with no height -->
            <ng-container *ngIf="activeTabNumber === 0">
              <ng-container *ngTemplateOutlet="dataSource"></ng-container>
            </ng-container>
          </div>
        </mat-tab>
        <!-- If we can add a source, then there is at least one
              data source selected so we allow changing graph options -->
        <!-- Currently none of the graph options are configuarble, commenting out for now -->
        <!-- <mat-tab label="GRAPH OPTIONS" [disabled]="!canChangeGraphOptions()">
          <div fxFlex [style.height]="'100%'">
            <ng-container *ngTemplateOutlet="GraphOptionsTab"></ng-container>
          </div>
        </mat-tab> -->
      </mat-tab-group>
    </div>
  </div>
</app-pagebody>

<ng-template #graph>
  <div fxFlex="100" fxLayout="column">
    <div fxFlex="auto" fxLayout="row">
      <app-chart #pChart fxFlex="100" type="line" [options]="graphOptions" [data]="lineData"
                 width="100%" height="100%" [responsive]="true"></app-chart>
    </div>
    <div fxFlex="50px" class="telemetry-graph-options" fxLayout="row"
         fxLayoutAlign="stretch center">
      <!-- <div style="margin: 0px 10px" fxFlex="none">Graph Type:</div>
      <p-dropdown fxFlex="none" [options]="graphTypeOptions" [(ngModel)]="selectedGraphType"
                  (onChange)="graphTypeChange()"></p-dropdown> -->
      <div fxFlex></div>
      <!-- <div style="margin: 0px 10px" fxFlex="none">Past 24hrs</div> -->
      <div style="margin: 0px 10px" fxFlex="none">
        <app-timerange (timeRange)="setTimeRange($event)"></app-timerange>
      </div>
    </div>
  </div>
</ng-template>

<ng-template #dataSource>
  <div fxFlex="100" fxLayout="column" class="telemetry-data-sources">
    <div fxFlex="none" fxLayout="row">
      <div class="global-button-primary telemetry-button"
           [ngClass]="canAddDataSource() ? '' : 'global-button-disabled'"
           (click)="addDataSourceClick()">
        ADD SOURCE
      </div>
    </div>
    <div fxFlex="10px"></div>
    <div fxFlex="auto" fxLayout="column" fxLayoutGap="10px" style="margin-left:10px">
      <div fxFlex="auto" fxLayout="column" *ngFor="let source of dataSources; let index = index"
           [@slideInOut] class="telemetry-data-source"
           (click)="index !== selectedDataSourceIndex ? viewSourceClick(index) : ''"
           [ngClass]="index === selectedDataSourceIndex ? 'telemetry-data-source-edit' : 'telemetry-data-source-view'">
        <div fxFlex='10px'></div>
        <div fxFlex="auto" fxLayout="column" [@slideInOut]
             *ngIf="index === selectedDataSourceIndex">
          <ng-container
                        *ngTemplateOutlet="EditSource; context: { $implicit: source, index: index }">
          </ng-container>
        </div>
        <div fxFlex="auto" fxLayout="column" [@slideInOut]
             *ngIf="index !== selectedDataSourceIndex">
          <ng-container
                        *ngTemplateOutlet="ViewSource; context: { $implicit: source, index: index }">
          </ng-container>
        </div>
        <div fxFlex='10px'></div>
      </div>
    </div>
  </div>
</ng-template>

<ng-template #ViewSource let-source let-index="index">
  <div fxFlex="none" fxLayout="row">
    <div fxFlex="none" fxLayout="row" fxLayoutGap="5px">
      <div fxFlex="none" [matTooltip]="getMeasurementMetadata(source.measurement).description">
        {{ getMeasurementMetadata(source.measurement).displayName }} </div>
      <div fxFlex="none"> - </div>
      <div fxFlex="none" *ngFor="let field of source.fields; let last = last;"
           [matTooltip]="getFieldMetadata(source.measurement, field).description">
        {{ !last && source.fields.length > 0 ? getFieldMetadata(source.measurement, field).displayName + ',' : getFieldMetadata(source.measurement, field).displayName }}
      </div>
    </div>
    <div fxFlex="15px"></div>
    <div fxFlex="none" fxLayout="row wrap" fxLayoutGap="10px">
      <ng-container *ngFor="let t of source.transforms" [ngSwitch]="t.transformName">
        <ng-container *ngSwitchCase="'GroupBy'">
          <ng-container
                        *ngTemplateOutlet="GroupByView; context:{groupBySource: t}">
          </ng-container>
        </ng-container>
      </ng-container>
    </div>
    <div fxFlex></div>

    <!-- COLOR TRANSFORM -->
    <div fxFlex="none" fxLayout="row" fxLayoutGap="5px" fxLayoutAlign="center center"
         class="telemetry-source-colors">
      <div fxFlex="none"
           *ngFor="let key of getObjectKeys(source.getTransform('ColorTransform').colors)"
           class="telemetry-color-icon"
           [style.background-color]="source.getTransform('ColorTransform').colors[key]"></div>
    </div>

    <div fxFlex="none" fxLayoutGap="10px" class="telemetry-source-action-buttons">
      <mat-icon [matTooltip]="'Edit Source'" class="telemetry-edit-icon"
                fxFlex="nogrow" (click)="viewSourceClick(index)">
        edit
      </mat-icon>
      <mat-icon [matTooltip]="'Delete Source'" class="telemetry-edit-icon"
                fxFlex="nogrow" (click)="deleteSourceClick($event, index)">
        delete
      </mat-icon>
    </div>
  </div>
</ng-template>


<ng-template #EditSource let-source>
  <div fxFlex="none">Measurement:</div>
  <mat-radio-group fxFlex="none" fxLayout="row wrap" fxLayoutAlign="start center"
                   fxLayoutGap="20px" class="telemetry-input telemetry-radio-buttons"

                   [(ngModel)]="source.measurement">
    <mat-radio-button fxFlex="250px" color="primary" [disableRipple]="true" class=""
                      *ngFor="let option of measurements"
                      [appErrorTooltip]="option.description"
                      [value]="option.name">
      {{option.displayName}}
    </mat-radio-button>
  </mat-radio-group>
  <div fxFlex="none" fxLayout="column" [@fastSlideInOut] *ngIf="source.measurement != null">
    <div fxFlex="none">Fields:</div>
    <div fxFlex="none" fxLayout="row wrap" fxLayoutAlign="start center" fxLayoutGap="20px"
         class="telemetry-input">
      <ng-container *ngFor="let option of metricsMetadata[source.measurement].fields">
        <p-checkbox fxFlex="200px" class="telemetry-checkbox-container"
                    *ngIf="option.baseType !== 'string'"
                    styleClass="telemetry-checkbox" labelStyleClass="telemetry-checkbox"
                    name="fieldSelection" [value]="option.name" [label]="option.displayName"
                    [appErrorTooltip]="option.description"
                    [(ngModel)]="source.fields"></p-checkbox>

      </ng-container>
    </div>
    <div [@fastSlideInOut] *ngIf="source.fields.length != 0" fxFlex="none" fxLayout="column">
      <div fxFlex="10px"></div>
      <div fxFlex="none" fxLayout="row wrap" fxLayoutAlign="space-between center">
        <ng-container *ngFor="let t of source.transforms" [ngSwitch]="t.transformName">
          <ng-container *ngSwitchCase="'GroupBy'">
            <ng-container *ngTemplateOutlet="GroupByEdit; context:{groupBySource: t}">
            </ng-container>
          </ng-container>
        </ng-container>
      </div>
      <div fxFlex="10px"></div>
    </div>
  </div>
</ng-template>

<ng-template #GraphOptionsTab>

</ng-template>


<!-- Transforms -->
<ng-template #GroupByEdit let-groupBySource="groupBySource">
  <div *ngIf="groupBySource.groupByOptions != null && groupBySource.groupByOptions.length > 1"
       fxFlex="none" fxLayout="row" fxLayoutAlign="start center">
    <div fxFlex="None">Group by: </div>
    <div fxFlex="5px"></div>
    <p-dropdown appendTo="body" fxFlex="200px" [options]="groupBySource.groupByOptions"
                [(ngModel)]="groupBySource.groupBy"></p-dropdown>
  </div>
</ng-template>

<ng-template #GroupByView let-groupBySource="groupBySource">
  <div *ngIf="groupBySource.groupBy != null" fxFlex="none" fxLayout="row" fxLayoutGap="5px"
       fxLayoutAlign="start center">
    <div fxFlex="None">Group by:</div>
    <div fxFlex="None">{{ groupBySource.groupBy }} </div>
  </div>
</ng-template>
