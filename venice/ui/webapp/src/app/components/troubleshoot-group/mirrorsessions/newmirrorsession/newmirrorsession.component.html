<div fxFlex="auto" fxLayout="column" class="psm-form newmirrorsession-container">
  <app-inlinebuttons class="newMirrorSession" *ngIf="isInline"
                     [saveButtonClass]="computeFormSubmitButtonClass()"
                     [saveTooltip]="getSubmitButtonToolTip()"
                     (saveFunc)="saveObject()" (cancelFunc)="cancelObject()">
  </app-inlinebuttons>
  <div fxFlex="auto" fxLayout="row wrap"
       [class]="isInline? 'newmirrorsession-editform-inline' : ''">
    <div fxFlex="50" fxLayout="column" fxLayoutAlign="start center"
         class="newmirrorsession-row">
      <ng-container *ngTemplateOutlet="meta"></ng-container>
      <div fxFlex="30px"></div>
      <ng-container *ngTemplateOutlet="packet"></ng-container>
      <div fxFlex="20px"></div>
      <ng-container *ngTemplateOutlet="collectors"></ng-container>
      <div fxFlex="20px"></div>
    </div>
    <div fxFlex="50" fxLayout="column" fxLayoutAlign="start"
         class="newmirrorsession-row">
      <mat-radio-group class="newmirrorsession-radio-text"
                       fxLayoutGap="20px"
                       [(ngModel)]="radioSelection" [ngModelOptions]="{standalone: true}">
        Mirror Packets by<div fxFlex="10px"></div>
        <mat-radio-button class="newmirrorsession-radio-text" fxFlex="nogrow" color="primary"
                          [disableRipple]="true" [value]="'rules'">
          Rules
        </mat-radio-button>
        <mat-radio-button class="newmirrorsession-radio-text" fxFlex="nogrow" color="primary"
                          [disableRipple]="true" [value]="'labels'">
          Uplink Interfaces
        </mat-radio-button>
      </mat-radio-group>
      <ng-container *ngIf="radioSelection == 'labels'">
        <ng-container *ngTemplateOutlet="interface_selector"></ng-container>
      </ng-container>
      <ng-container *ngIf="radioSelection == 'rules'">
        <ng-container *ngTemplateOutlet="match_rules"></ng-container>
      </ng-container>
    </div>
  </div>
</div>

<ng-template #meta>
  <div fxFlex="none" fxLayout="row">
    <span [formGroup]="newObject.$formGroup.get(['meta'])"
          [ngClass]="{
          'newmirrorsession-general-box': true,
          'requiredField': isFieldEmpty(newObject.$formGroup.get(['meta', 'name']))
        }">
      <input autocomplete="off" formControlName="name" appFloatLabel="Unique Name"
             appErrorTooltip spellcheck="false" type="text" pInputText>
    </span>
    <div fxFlex="89px"></div>
    <span [formGroup]="newObject.$formGroup.get(['spec'])"
          [ngClass]="{
            'newmirrorsession-general-box': true,
            'requiredField': isFieldEmpty(newObject.$formGroup.get(['spec', 'span-id']))
          }">
      <input autocomplete="off" formControlName="span-id" appFloatLabel="ERSPAN ID"
             appErrorTooltip spellcheck="false" type="number" min="1" max="1023" pInputText>
    </span>
  </div>
</ng-template>

<ng-template #packet>
  <div fxFlex="none" fxLayout="row">
    <span [formGroup]="newObject.$formGroup.get(['spec'])"
          class="newmirrorsession-general-box">
      <input autocomplete="off" formControlName="packet-size" appFloatLabel="Packet Size"
             appErrorTooltip spellcheck="false" type="number" min="0" pInputText>
    </span>
    <div fxFlex="79px"></div>
    <app-psmcalendar fxFlex="260px" id="newmirrorsession-schedule-calendar"
                     label="Schedule (UTC)" [minDate]="minDate" [defaultDate]="defaultDate"
                     [formControl]="newObject.$formGroup.get(['spec', 'start-condition', 'schedule-time'])">
    </app-psmcalendar>
    <!--
    <span [formGroup]="newObject.$formGroup.get(['spec'])"
          class="newmirrorsession-general-box">
      <p-multiSelect appFloatLabel="Packet Filters"
                     appendTo="body" [showHeader]="false"
                     formControlName="packet-filters" [filter]="false" [showToggleAll]="false"
                     defaultLabel="All" [options]="packetFilterOptions">
      </p-multiSelect>
    </span>
    -->
  </div>
</ng-template>

<ng-template #collectors>
  <app-fieldcontainer class="newmirrorsession-collectors"
                      fieldTitle="Collectors" subtitle="(specify one or more)">
    <app-listcontainer
                       [formGroup]="newObject.$formGroup.get(['spec', 'collectors'])"
                       [isInline]="isInline"
                       [itemTemplate]="collectRowTemplate" addText="COLLECTOR" [maxiumCount]="2"
                       (addItem)="addCollector()" (deleteItem)="removeCollector($event)">
    </app-listcontainer>
  </app-fieldcontainer>
</ng-template>

<ng-template #collectRowTemplate let-collector="item" let-index="index">
  <div fxFlex="520px" fxLayout="row" [formGroup]="collector">
    <span fxFlex="none" fxLayout="row" class="newmirrorsession-collector-box">
      <p-dropdown appFloatLabel="Type" appendTo="body"
                  [options]="collectorTypeOptions" formControlName="type">
      </p-dropdown>
    </span>
    <div fxFlex="10px"></div>
    <span fxFlex="none" fxLayout="row" [formGroup]="collector.get(['export-config'])"
          [ngClass]="{
          'newmirrorsession-collector-box': true,
          'requiredField': isFieldEmpty(collector.get(['export-config', 'destination']))
        }">
      <input autocomplete="off" fxFlex="nogrow" appFloatLabel="Destination" appErrorTooltip
             formControlName="destination" spellcheck="false" type="text" pInputText>
    </span>
    <div fxFlex="10px"></div>
    <span fxFlex="none" fxLayout="row" [formGroup]="collector.get(['export-config'])"
          class="newmirrorsession-collector-box">
      <input autocomplete="off" fxFlex="nogrow" appFloatLabel="DSC-Gateway" appErrorTooltip
             formControlName="gateway" spellcheck="false" type="text" pInputText>
    </span>
    <div fxFlex="10px"></div>
    <span fxFlex="none" fxLayout="row">
      <span class="newmirrorsession-stripvlan-label">Strip VLAN</span>
      <p-inputSwitch class="newmirrorsession-stripvlan-toggle" appendTo="body"
                     [appErrorTooltip]="'Remove VLAN info from mirror packets'"
                     formControlName="strip-vlan-hdr"></p-inputSwitch>
    </span>
  </div>
</ng-template>

<ng-template #interface_selector>
  <app-fieldcontainer class="newmirrorsession-selectors"
                      fieldTitle="Uplink Interfaces" subtitle="(select from interface labels)">
    <div fxLayout="column">
      <div fxFlex="none" fxLayout="row" class="newmirrorsession-interface-direction-box"
           [formGroup]="newObject.$formGroup.get(['spec', 'interfaces'])">
        <p-dropdown appFloatLabel="Direction" appendTo="body"
                    [options]="interfaceDirectionOptions" formControlName="direction">
        </p-dropdown>
      </div>
      <div fxFlex="auto"
           class="newmirrorsession-section-div newmirrorsession-section-workloadlabels-div">
        <app-listcontainer
                           [formGroup]="newObject.$formGroup.get(['spec', 'interfaces', 'selectors', 0, 'requirements'])"
                           [itemTemplate]="interfaceRowTemplate" (addItem)="addInterfaceSelector()"
                           addText="AND" [addButtonTooltip]="AND_BUTTON_TOOLTIP"
                           [isInline]="isInline" (deleteItem)="removeInterfaceSelector($event)">
        </app-listcontainer>
      </div>
      <div fxFlex="auto" class="newmirrorsession-label-match-count"
           *ngIf="getAllInterfaceSelectorsValues()">
        <ng-container *ngIf="getLabelMatchInfo() as labelMatchInfo">
          <span class="newmirrorsession-label-match-tooltip"
                [matTooltipClass]="'newmirrorsession-label-match-tooltip-tooltip'"
                [matTooltip]="labelMatchInfo.title">{{ labelMatchInfo.count }} Uplink Interfaces
            matched.</span>
        </ng-container>
      </div>
    </div>
  </app-fieldcontainer>
</ng-template>

<ng-template #interfaceRowTemplate let-selector="item" let-index="index">
  <div fxFlex="540px" fxLayout="row" [formGroup]="selector">
    <span fxFlex="none" fxLayout="row" [ngClass]="{
        'newmirrorsession-interface-box': true,
        'selectboxWithValue': true,
        'requiredField': isFieldEmpty(selector.get(['key']))
    }">
      <p-dropdown formControlName="key" appFloatLabel="Label Key" editable="true"
                  appendTo="body" [appErrorTooltip]="LABELKEY_TOOLTIP"
                  class="newmirrorsession-interface-selectbox" [options]="labelKeyOptions"
                  (onChange)="onInterfaceKeyChange(selector)">
        <ng-template let-item pTemplate="item">
          <span *ngIf="item.value">{{item.label}}</span>
        </ng-template>
      </p-dropdown>
    </span>
    <div fxFlex="15px"></div>
    <span fxFlex="none" fxLayout="row" class="newmirrorsession-interface-operator-box">
      <p-dropdown appFloatLabel="Operator" appendTo="body"
                  class="newmirrorsession-interface-selectbox"
                  [options]="labelOperatorOptions" formControlName="operator">
      </p-dropdown>
    </span>
    <div fxFlex="15px"></div>
    <app-psmchipsbox class="newmirrorsession-interface-chips-box"
                     *ngIf="!labelValueOptionsMap[selector.get(['key']).value] as labelValueOptions"
                     fxFlex="210px" label="Label Values" [formControl]="selector.get('values')"
                     [showRequired]="isFieldEmpty(selector.get(['values']))"
                     [toolTip]="LABELVALUES_TOOLTIP">
    </app-psmchipsbox>
    <span *ngIf="labelValueOptionsMap[selector.get(['key']).value] as labelValueOptions"
          fxFlex="none" fxLayout="row" [ngClass]="{
        'newmirrorsession-interface-box': true,
        'selectboxWithValue': true,
        'requiredField': isFieldEmpty(selector.get(['values'])) && labelValueOptions
    }">
      <p-multiSelect appFloatLabel="Label Values" appendTo="body"
                     formControlName="values" class="newmirrorsession-interface-selectbox"
                     [options]="labelValueOptions || []"
                     [appErrorTooltip]="LABELVALUES_SELECT_TOOLTIP"
                     [filter]="false" [showHeader]="false" [showToggleAll]="false">
      </p-multiSelect>
    </span>
  </div>
</ng-template>

<ng-template #match_rules>
  <div fxFlex="none" fxLayout="column">
    <div fxFlex="none" fxLayout="row">
      <div fxFlex="none" [ngClass]="{'requiredLabel': areAllRulesEmpty()}">Rules:</div>
      <div fxFlex="5px"></div>
      <div fxFlex="none" class="newmirrorsession-subtext">(specify one or more)</div>
    </div>
    <div fxFlex="10px"></div>
    <app-orderedlist
                     [enableDragDrop]="false" [enableOrdering]="false" [dataArray]="rules"
                     [templateEdit]="ruleTemplateEdit" [templateView]="ruleTemplateView"
                     (addItem)="addRule()" (deleteItem)="deleteRule($event)">
    </app-orderedlist>
  </div>
</ng-template>

<ng-template #ruleTemplateEdit let-data="data" let-index="index" let-inEdit="inEdit">
  <!-- data is MonitoringMatchRule -->
  <div fxFlex="auto" fxLayout="column" fxLayoutGap="15px">
    <div fxFlex="none" fxLayout="row" fxLayoutGap="10px" class="newmirrorsession-rule-row">
      <app-psmchipsbox fxFlex="270px" [label]="'Source ' + IPS_LABEL"
                       [formControl]="data.rule.$formGroup.get(['source', 'ip-addresses'])"
                       [itemValidator]="isValidIP" [itemErrorMsg]="IPS_ERRORMSG">
      </app-psmchipsbox>
      <app-psmchipsbox fxFlex="270px" [label]="'Destination ' + IPS_LABEL"
                       [formControl]="data.rule.$formGroup.get(['destination', 'ip-addresses'])"
                       [itemValidator]="isValidIP" [itemErrorMsg]="IPS_ERRORMSG">
      </app-psmchipsbox>
    </div>
    <div fxFlex="none" class="newmirrorsession-rule-row">
      <app-psmchipsbox fxFlex="270px" label="Protocol / Ports"
                       [formControl]="data.rule.$formGroup.get(['app-protocol-selectors', 'proto-ports'])"
                       [itemValidator]="isValidProto" [itemErrorMsg]="PROTS_ERRORMSG"
                       [toolTip]="PROTS_TOOLTIP">
      </app-psmchipsbox>
    </div>
  </div>
</ng-template>

<ng-template #ruleTemplateView let-data="data" let-index="index" let-inEdit="inEdit">
  <div fxFlex="auto" fxLayout="column"
       fxLayoutAlign="start none" class="newmirrorsession-rule-template">
    <div fxFlex="auto" fxLayout="row" fxLayoutAlign="start start">
      <div fxFlex="10px"></div>
      <div fxFlex="90%" fxLayout="row wrap" fxLayoutAlign="space-between start">
        <div fxFlex="33" fxLayout="column" fxLayouAlign="start start">
          <div fxFlex="none" class="newmirrorsession-bold">Source</div>
          <div fxFlex="5px"></div>
          <div *ngIf="data.rule.$formGroup.get(['source', 'ip-addresses']).value.length !== 0"
               fxFlex="none" fxLayout="row">
            <div fxFlex="none" class="newmirrorsession-bold-subtext-ipmac">IP:</div>
            <div fxFlex="none" fxLayout="column">
              <span *ngFor="let ip of getDataArray(data, 'source', 'ip-addresses')"
                    class="newmirrorsession-rule-content">
                {{ip}}
              </span>
            </div>
          </div>
        </div>

        <div fxFlex="33" fxLayout="column" fxLayouAlign="start start">
          <div fxFlex="none" class="newmirrorsession-bold">Destination</div>
          <div fxFlex="5px"></div>
          <div *ngIf="data.rule.$formGroup.get(['destination', 'ip-addresses']).value.length !== 0"
               fxFlex="none" fxLayout="row">
            <div fxFlex="none" class="newmirrorsession-bold-subtext-ipmac">IP:</div>
            <div fxFlex="none" fxLayout="column">
              <span *ngFor="let ip of getDataArray(data, 'destination', 'ip-addresses')"
                    class="newmirrorsession-rule-content">
                {{ip}}
              </span>
            </div>
          </div>
        </div>

        <div fxFlex="34" fxLayout="column" fxLayouAlign="start start">
          <div fxFlex="none" class="newmirrorsession-bold">PROTO-PORTS/APPS</div>
          <div fxFlex="5px"></div>
          <div *ngIf="data.selectedProtoAppOption === 'proto-ports' && 
            data.rule.$formGroup.get(['app-protocol-selectors', 'proto-ports']).value.length !== 0"
               fxFlex="none" fxLayout="row">
            <div fxFlex="none" class="newmirrorsession-bold-subtext-proto">Proto-ports:</div>
            <div fxFlex="none" fxLayout="column">
              <span *ngFor="let proto of getDataArray(data, 'app-protocol-selectors', 'proto-ports')"
                    class="newmirrorsession-rule-content">
                {{proto}}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</ng-template>
