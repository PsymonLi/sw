<div fxFlex="auto" fxLayout="column" class="psm-form newmirrorsession-container">
  <app-inlinebuttons class="newMirrorSession" *ngIf="isInline" [form]="this">
  </app-inlinebuttons>
  <div [class]="isInline? 'newmirrorsession-editform-inline' : ''">
    <div fxFlex="auto" fxLayout="row wrap" class="psm-form-content">
      <div fxFlex="noshrink" fxLayout="column" fxLayoutAlign="start center">
        <ng-container *ngTemplateOutlet="meta"></ng-container>
        <div fxFlex="30px"></div>
        <ng-container *ngTemplateOutlet="packet"></ng-container>
        <div fxFlex="20px"></div>
        <ng-container *ngTemplateOutlet="collectors"></ng-container>
        <div fxFlex="20px"></div>
      </div>
      <div fxFlex="noshrink" fxLayout="column" fxLayoutAlign="start center">
        <div fxFlex="none" fxLayout="row">
          <app-psmradiobuttons fxFlex="590px" [formControl]="radioSelectionCtrl"
                               [options]="radioOptions" label="Mirror Packets By">
          </app-psmradiobuttons>
        </div>
        <ng-container *ngIf="radioSelectionCtrl.value === 'labels'">
          <ng-container *ngTemplateOutlet="interface_selector"></ng-container>
        </ng-container>
        <ng-container *ngIf="radioSelectionCtrl.value === 'rules'">
          <ng-container *ngTemplateOutlet="match_rules"></ng-container>
        </ng-container>
      </div>
    </div>
  </div>
</div>

<ng-template #meta>
  <div fxFlex="none" fxLayout="row">
    <app-psmtextbox fxFlex="250px" label="Name"
                    [formControl]="newObject.$formGroup.get(['meta', 'name'])">
    </app-psmtextbox>
    <div fxFlex="89px"></div>
    <app-psmnumberbox fxFlex="250px" label="ERSPAN ID" min="1" max="1023"
                      [formControl]="newObject.$formGroup.get(['spec', 'span-id'])">
    </app-psmnumberbox>
  </div>
</ng-template>

<ng-template #packet>
  <div fxFlex="none" fxLayout="row">
    <app-psmnumberbox fxFlex="250px" label="Packet Size" min="0"
                      [formControl]="newObject.$formGroup.get(['spec', 'packet-size'])">
    </app-psmnumberbox>
    <div fxFlex="89px"></div>
    <app-psmcalendar fxFlex="250px" id="newmirrorsession-schedule-calendar"
                     label="Schedule (UTC)" [minDate]="minDate" [defaultDate]="defaultDate"
                     [formControl]="newObject.$formGroup.get(['spec', 'start-condition', 'schedule-time'])">
    </app-psmcalendar>
  </div>
</ng-template>

<ng-template #collectors>
  <app-fieldcontainer class="newmirrorsession-collectors"
                      fieldTitle="Collectors" subtitle="(specify one or more)">
    <app-listcontainer
                       [formGroup]="newObject.$formGroup.get(['spec', 'collectors'])"
                       [isInline]="isInline"
                       [itemTemplate]="collectRowTemplate" addText="COLLECTOR" [maxiumCount]="2"
                       (addItem)="addCollector()" (deleteItem)="removeCollector($event)">
    </app-listcontainer>
  </app-fieldcontainer>
</ng-template>

<ng-template #collectRowTemplate let-collector="item" let-index="index">
  <div fxFlex="545px" fxLayout="row" [formGroup]="collector">
    <app-psmselectbox fxFlex="150px" label="Type" formControlName="type"
                      [options]="collectorTypeOptions">
    </app-psmselectbox>
    <div fxFlex="10px"></div>
    <app-psmtextbox fxFlex="150px" label="Destination"
                    [formControl]="collector.get(['export-config', 'destination'])">
    </app-psmtextbox>
    <div fxFlex="10px"></div>
    <app-psmtextbox fxFlex="150px" label="DSC-Gateway"
                    [formControl]="collector.get(['export-config', 'gateway'])">
    </app-psmtextbox>
    <div fxFlex="10px"></div>
    <app-psmtoggle fxFlex="60px" label="Strip VLAN" formControlName="strip-vlan-hdr">
    </app-psmtoggle>
  </div>
</ng-template>

<ng-template #interface_selector>
  <app-fieldcontainer class="newmirrorsession-selectors"
                      fieldTitle="Uplink Interfaces" subtitle="(select from interface labels)">
    <div fxLayout="column">
      <div fxFlex="none" fxLayout="row"
           [formGroup]="newObject.$formGroup.get(['spec', 'interfaces'])">
        <app-psmselectbox fxFlex="180px" label="Direction" formControlName="direction"
                          [options]="interfaceDirectionOptions">
        </app-psmselectbox>
      </div>
      <div fxFlex="15px"></div>
      <app-listcontainer
                         [formGroup]="newObject.$formGroup.get(['spec', 'interfaces', 'selectors', 0, 'requirements'])"
                         [itemTemplate]="interfaceRowTemplate" (addItem)="addInterfaceSelector()"
                         addText="AND" [addButtonTooltip]="AND_BUTTON_TOOLTIP"
                         [isInline]="isInline" (deleteItem)="removeInterfaceSelector($event)">
      </app-listcontainer>
      <div fxFlex="auto" class="newmirrorsession-label-match-count"
           *ngIf="getAllInterfaceSelectorsValues()">
        <ng-container *ngIf="getLabelMatchInfo() as labelMatchInfo">
          <span class="newmirrorsession-label-match-tooltip"
                [matTooltipClass]="'newmirrorsession-label-match-tooltip-tooltip'"
                [matTooltip]="labelMatchInfo.title">{{ labelMatchInfo.count }} Uplink Interfaces
            matched.
          </span>
        </ng-container>
      </div>
    </div>
  </app-fieldcontainer>
</ng-template>

<ng-template #interfaceRowTemplate let-selector="item" let-index="index">
  <div fxFlex="555px" fxLayout="row" [formGroup]="selector">
    <app-psmselectbox fxFlex="210px" label="Label Key" editable="true"
                      [hintTooltip]="LABELKEY_TOOLTIP" [options]="labelKeyOptions"
                      formControlName="key">
    </app-psmselectbox>
    <div fxFlex="5px"></div>
    <app-psmselectbox fxFlex="110px" label="Operator"
                      [options]="labelOperatorOptions" formControlName="operator">
    </app-psmselectbox>
    <div fxFlex="15px"></div>
    <app-psmchipsbox class="newmirrorsession-interface-chips-box"
                     *ngIf="!labelValueOptionsMap[selector.get(['key']).value] as labelValueOptions"
                     fxFlex="210px" label="Label Values" formControlName="values"
                     [showRequired]="isFieldEmpty(selector.get(['values']))"
                     [toolTip]="LABELVALUES_TOOLTIP">
    </app-psmchipsbox>
    <app-psmmultiselectbox
                           *ngIf="labelValueOptionsMap[selector.get(['key']).value] as labelValueOptions"
                           fxFlex="210px" label="Label Values" formControlName="values"
                           [showRequired]="isFieldEmpty(selector.get(['values']))"
                           [options]="labelValueOptions" [hintTooltip]="LABELVALUES_SELECT_TOOLTIP">
    </app-psmmultiselectbox>
  </div>
</ng-template>

<ng-template #match_rules>
  <div fxFlex="none" fxLayout="column">
    <div fxFlex="none" fxLayout="row">
      <div fxFlex="10px"></div>
      <div fxFlex="none" [ngClass]="{'requiredLabel': areAllRulesEmpty()}">Rules:</div>
      <div fxFlex="5px"></div>
      <div fxFlex="none" class="newmirrorsession-subtext">(specify one or more)</div>
    </div>
    <div fxFlex="10px"></div>
    <app-orderedlist
                     [enableDragDrop]="false" [enableOrdering]="false" [dataArray]="rules"
                     [templateEdit]="ruleTemplateEdit" [templateView]="ruleTemplateView"
                     (addItem)="addRule()" (deleteItem)="deleteRule($event)">
    </app-orderedlist>
  </div>
</ng-template>

<ng-template #ruleTemplateEdit let-data="data" let-index="index" let-inEdit="inEdit">
  <!-- data is MonitoringMatchRule -->
  <div fxFlex="auto" fxLayout="column" fxLayoutGap="15px">
    <div fxFlex="none" fxLayout="row" fxLayoutGap="10px">
      <app-psmchipsbox fxFlex="270px" [label]="'Source ' + IPS_LABEL"
                       [formControl]="data.rule.$formGroup.get(['source', 'ip-addresses'])"
                       [itemValidator]="isValidIP" [itemErrorMsg]="IPS_ERRORMSG">
      </app-psmchipsbox>
      <app-psmchipsbox fxFlex="270px" [label]="'Destination ' + IPS_LABEL"
                       [formControl]="data.rule.$formGroup.get(['destination', 'ip-addresses'])"
                       [itemValidator]="isValidIP" [itemErrorMsg]="IPS_ERRORMSG">
      </app-psmchipsbox>
    </div>
    <div fxFlex="none" fxLayout="row">
      <app-psmchipsbox fxFlex="270px" label="Protocol / Ports"
                       [formControl]="data.rule.$formGroup.get(['app-protocol-selectors', 'proto-ports'])"
                       [itemValidator]="isValidProto" [itemErrorMsg]="PROTS_ERRORMSG"
                       [toolTip]="PROTS_TOOLTIP">
      </app-psmchipsbox>
    </div>
  </div>
</ng-template>

<ng-template #ruleTemplateView let-data="data" let-index="index" let-inEdit="inEdit">
  <div fxFlex="auto" fxLayout="column" fxLayoutAlign="start none">
    <div fxFlex="auto" fxLayout="row" fxLayoutAlign="start start">
      <div fxFlex="20px"></div>
      <div fxFlex="100%" fxLayout="row">
        <ng-container *ngTemplateOutlet="ruleColumnTemplate; context:{title: 'Source', subtitleWidth: '40px',
            subtitle: 'IP', list: data.rule.$formGroup.get(['source', 'ip-addresses']).value}">
        </ng-container>
        <ng-container
                      *ngTemplateOutlet="ruleColumnTemplate; context:{title: 'Destination', subtitleWidth: '40px',
            subtitle: 'IP', list: data.rule.$formGroup.get(['destination', 'ip-addresses']).value}">
        </ng-container>
        <ng-container
                      *ngTemplateOutlet="ruleColumnTemplate; context:{title: 'PROTO-PORTS/APPS', subtitleWidth: '80px',
            subtitle: 'Proto-ports', list: data.rule.$formGroup.get(['app-protocol-selectors', 'proto-ports']).value}">
        </ng-container>
      </div>
    </div>
  </div>
</ng-template>

<ng-template #ruleColumnTemplate let-title="title" let-subtitle="subtitle"
             let-subtitleWidth="subtitleWidth" let-list="list">
  <div fxFlex="1 1 100%" fxLayout="column" fxLayouAlign="start start">
    <div fxFlex="none" class="newmirrorsession-bold">{{title}}</div>
    <div fxFlex="5px"></div>
    <div *ngIf="list && list.length > 0" fxFlex="none" fxLayout="row">
      <div fxFlex="{{subtitleWidth}}" class="newmirrorsession-bold-subtext">{{subtitle}}:</div>
      <div fxFlex="none" fxLayout="column">
        <span *ngFor="let item of list" class="newmirrorsession-rule-content">{{item}}</span>
      </div>
    </div>
  </div>
</ng-template>
