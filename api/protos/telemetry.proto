// {C} Copyright 2017 Pensando Systems Inc. All rights reserved.

syntax = "proto3";
// Service name
package telemetry;

// Mandatory imports.
import "google/api/annotations.proto";
import public "github.com/pensando/sw/venice/utils/apigen/annotations/includes.proto";
import "github.com/gogo/protobuf/gogoproto/gogo.proto";
import "github.com/pensando/sw/api/meta.proto";
import "github.com/pensando/sw/api/export.proto";

// telemetry policies:
//-------------------------------------------------------------------------------
// policy name         |  intended for        |     description                 |
//-------------------------------------------------------------------------------
// stats               |  sys admins          |    for all stats other than     |
//                     |                      |    fwlog/netflow.               |
//                     |                      |    includes retention,compaction|
//-------------------------------------------------------------------------------
// fwlog               |  security admins     |    firewall log policy          |
//                     |                      |    includes retention,          |
//                     |                      |    export parameters            |
//-------------------------------------------------------------------------------
//                     |                      |                                 |
// flowexport          |  network admins      |    netflow export policy        |
//                     |                      |    includes interval,           |
//                     |                      |    export parameters            |
//-------------------------------------------------------------------------------
//
//=========================================================================================
//  stats policy
//=========================================================================================
message StatsStatus {

}

// compaction method will be selected by Venice based on the mesaurement/table
// collection interval will be selected by Venice based on workloads
message StatsSpec {
     // Compaction Interval is the down sampling interval in minutes, hours or days
     // this would be mapped to GROUP BY TIME() in influxdb CQ
     // example: SELECT MAX(*) INTO downsampled_xxx FROM xxx GROUP BY time(CompactionInterval),host
     string CompactionInterval  = 1 [(gogoproto.jsontag) = "compaction-interval ,omitempty"];

     // RetentionTime defines for how long to keep the stats data before it is deleted
     // The value is specified as a string format to be hours, days, or months etc.
     // e.g. '24hrs', '72hours', '4days', '6d', '2months', '4mo', '1yr'
     string RetentionTime = 2 [(gogoproto.jsontag) = "retention-time,omitempty"];

     // DownSampleRetentionTime defines for how long to keep the down sampled data before it is deleted
     // The value is specified as a string format to be hours, days, or months etc.
     // e.g. '24hrs', '72hours', '4days', '6d', '2months', '4mo', '1yr'
     string DownSampleRetentionTime = 3 [(gogoproto.jsontag) = "downsample-retention-time,omitempty"];
}

message StatsPolicy {
    option (venice.objectPrefix) = {Collection: "StatsPolicy", Path: "/{O.Tenant}"};
    api.TypeMeta T =1 [(gogoproto.embed) = true, (gogoproto.nullable) = false, (gogoproto.jsontag) = ",inline"];
    api.ObjectMeta O =2 [(gogoproto.embed) = true, (gogoproto.nullable) = false, (gogoproto.jsontag) = "meta,omitempty"];

    StatsSpec Spec = 3 [(gogoproto.nullable) = false, (gogoproto.jsontag) = "spec,omitempty"];

    // Status contains the current state of the policy.
    StatsStatus Status = 4 [(gogoproto.nullable) = false, (gogoproto.jsontag) = "status,omitempty"];
}

// StatsPolicy REST API
service StatsPolicyV1 {
    // Prefix for all resources served by this service.
    option (venice.apiPrefix) = "statsPolicy";
    // API Version.
    option (venice.apiVersion) = "v1";

    option (venice.apiGrpcCrudService) = "StatsPolicy";

    option (venice.apiRestService) = {
        Object: "StatsPolicy"
        Method: [ "get", "put", "delete", "post", "list" ]
    };
}

//=========================================================================================
//  firewall log policy
//=========================================================================================

message FwlogStatus {
}

// firewall log export formats
enum FwlogExportFormat {
        SYSLOG_BSD = 0;
        SYSLOG_RFC5424 = 1;
}

enum FwlogFilter {
    FWLOG_ALL = 0;
    FWLOG_ACCEPT = 1;
    FWLOG_REJECT= 2;
    FWLOG_DENY = 3;
}

// firewall log export config
message FwlogExport {
    // Target contains ip/port/protocol
    repeated api.ExportConfig Targets = 1 [(gogoproto.nullable) = false, (gogoproto.jsontag) = "targets,omitempty"];

     // fwlog format, SYSLOG_BSD default
    string Format = 2 [(gogoproto.jsontag) = "format,omitempty", (venice.check) = "StrEnum(FwlogExportFormat)"];

    // filter firewall logs, FWLOG_ALL default
    repeated string Filter = 3 [(gogoproto.jsontag) = "export-filter,omitempty", (venice.check) = "StrEnum(FwlogFilter)"];

    // configuration to use for syslog format
    // default facility is set to "local4", can be overridden with FacilityOverride
    // fwlog serverity is set to "Informational"
    api.SyslogExportConfig SyslogConfig = 4 [(gogoproto.jsontag) = "syslog-config,omitempty"];
}

// Venice collects fwlog irrespective of the export config
message FwlogSpec {
    // RetentionTime defines for how long to keep the fwlog before it is deleted
    string RetentionTime = 1 [(gogoproto.jsontag) = "retention-time,omitempty"];

    // filter firewall logs for venice, FWLOG_ALL default
    repeated string Filter = 2 [(gogoproto.jsontag) = "filter,omitempty", (venice.check) = "StrEnum(FwlogFilter)"];

    // Export contains the export config
    repeated FwlogExport Exports = 3 [(gogoproto.jsontag) = "exports,omitempty"];
}

message FwlogPolicy {
    option (venice.objectPrefix) = {Collection: "fwlogPolicy", Path: "/{O.Tenant}"};
    api.TypeMeta T =1 [(gogoproto.embed) = true, (gogoproto.nullable) = false, (gogoproto.jsontag) = ",inline"];
    api.ObjectMeta O =2 [(gogoproto.embed) = true, (gogoproto.nullable) = false, (gogoproto.jsontag) = "meta,omitempty"];

    FwlogSpec Spec = 3 [(gogoproto.nullable) = false, (gogoproto.jsontag) = "spec,omitempty"];

    // Status contains the current state of the policy.
    FwlogStatus Status = 4 [(gogoproto.nullable) = false, (gogoproto.jsontag) = "status,omitempty"];
}

// FwlogPolicy REST API
service FwlogPolicyV1 {
    // Prefix for all resources served by this service.
    option (venice.apiPrefix) = "fwlogPolicy";
    // API Version.
    option (venice.apiVersion) = "v1";

    option (venice.apiGrpcCrudService) = "FwlogPolicy";

    option (venice.apiRestService) = {
        Object: "FwlogPolicy"
        Method: [ "get", "put", "delete", "post", "list" ]
    };
}

//========================================================================================
//  flow export policy
//========================================================================================
message FlowExportStatus {
}

message FlowExportTarget {
    enum Formats {
        Ipfix = 0;
    }
    // Interval defines how often to push the records to an external or internal collector
    // The value is specified as a string format to be '10s', '20m', '20mins', '10secs', '10seconds'
    string Interval = 1 [(gogoproto.jsontag) = "interval,omitempty"];

    string Format = 2 [(gogoproto.jsontag) = "format,omitempty", (venice.check) = "StrEnum(FlowExportTarget.Formats)"];

    // Export contains export parameters.
    repeated api.ExportConfig Exports = 3 [(gogoproto.nullable) = false, (gogoproto.jsontag) = "exports,omitempty"];

}

message FlowExportSpec {
    repeated FlowExportTarget Targets = 1 [(gogoproto.nullable) = false, (gogoproto.jsontag) = "targets,omitempty"];
}

message FlowExportPolicy {
    option (venice.objectPrefix) = {Collection: "flowExportPolicy", Path: "/{O.Tenant}"};
    api.TypeMeta T =1 [(gogoproto.embed) = true, (gogoproto.nullable) = false, (gogoproto.jsontag) = ",inline"];
    api.ObjectMeta O =2 [(gogoproto.embed) = true, (gogoproto.nullable) = false, (gogoproto.jsontag) = "meta,omitempty"];

    FlowExportSpec Spec = 3 [(gogoproto.nullable) = false, (gogoproto.jsontag) = "spec,omitempty"];

    // Status contains the current state of the export policy.
    FlowExportStatus Status = 4 [(gogoproto.nullable) = false, (gogoproto.jsontag) = "status,omitempty"];
}

// FlowExportPolicyV1 REST API
service FlowExportPolicyV1 {
    // Prefix for all resources served by this service.
    option (venice.apiPrefix) = "flowExportPolicy";
    // API Version.
    option (venice.apiVersion) = "v1";

    option (venice.apiGrpcCrudService) = "FlowExportPolicy";

    option (venice.apiRestService) = {
        Object: "FlowExportPolicy"
        Method: [ "get", "put", "delete", "post", "list" ]
    };
}
